- id: '1719750374699'
  alias: Sauvegarde manuelle
  description: ''
  trigger:
  - platform: state
    entity_id:
    - input_button.backup
    from:
    to:
  condition: []
  action:
  - service: hassio.backup_full
    data:
      compressed: true
      homeassistant_exclude_database: false
  mode: single
- id: '1719771464619'
  alias: Changement IP Fixe
  description: ''
  trigger:
  - platform: state
    entity_id:
    - sensor.myip
  condition:
  - condition: state
    entity_id: sensor.myip
    state: not unknown
  - condition: state
    entity_id: sensor.myip
    state: not unavailable
  action:
  - metadata: {}
    data:
      message: 'Nouvelle IP Fixe : {{states(''sensor.myip'')}}'
    action: notify.notify
  mode: single
- id: '1719775557204'
  alias: Départ en vacances
  description: 'Fermeture de tous les volets/stores/fenêtres sauf Garage

    Activation du mode alarme sur ouvertures/caméras'
  triggers:
  - entity_id:
    - input_button.depart_en_vacances
    trigger: state
  conditions:
  - condition: state
    entity_id: input_boolean.automatisation
    state: 'on'
  actions:
  - device_id: 2bd1859f74267146aa2087e82d1ffd4f
    domain: button
    entity_id: 38477b2ac9f932c74d15d3041385d4cb
    type: press
  - metadata: {}
    data: {}
    target:
      entity_id: input_boolean.mode_alarme
    action: input_boolean.turn_on
  - type: turn_off
    device_id: 62be3297a0c0d75c708f1a2e49911819
    entity_id: 84ede9c070c6abc84dbd5367e484c988
    domain: switch
  mode: single
- id: '1719776952844'
  alias: Retour de vacances
  description: Active le Chauffe eau et désactive les alarmes
  trigger:
  - platform: state
    entity_id:
    - input_button.retour_de_vacances
  condition:
  - condition: state
    entity_id: input_boolean.automatisation
    state: 'on'
  action:
  - type: turn_on
    device_id: 62be3297a0c0d75c708f1a2e49911819
    entity_id: 84ede9c070c6abc84dbd5367e484c988
    domain: switch
  - service: input_boolean.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: input_boolean.mode_alarme
  mode: single
- id: '1719836236088'
  alias: Alerte Mémoire
  description: ''
  triggers:
  - entity_id:
    - sensor.system_monitor_utilisation_de_la_memoire
    above: 50
    trigger: numeric_state
  conditions: []
  actions:
  - action: notify.persistent_notification
    data:
      message: 'Utilisation de la mémoire > 50% :     {{states(''sensor.system_monitor_utilisation_de_la_memoire'')}}%'
  - action: notify.notify
    data:
      message: 'Utilisation de la mémoire > 50% :         {{states(''sensor.system_monitor_utilisation_de_la_memoire'')}}%'
  mode: single
- id: '1719836323085'
  alias: Alerte CPU
  description: ''
  triggers:
  - entity_id:
    - sensor.system_monitor_charge_5m
    above: 1
    trigger: numeric_state
  conditions: []
  actions:
  - metadata: {}
    data:
      message: 'Utilisation du CPU importante : {{states(''sensor.system_monitor_charge_5m'')}}'
    action: notify.notify
  - metadata: {}
    data:
      message: 'Utilisation du CPU importante : {{states(''sensor.system_monitor_charge_5m'')}}'
    action: persistent_notification.create
  mode: single
- id: '1719933755667'
  alias: Cycle ECS
  description: ''
  triggers:
  - entity_id:
    - sensor.cumulus_2
    above: 5
    trigger: numeric_state
    for:
      hours: 0
      minutes: 1
      seconds: 0
    id: debut
  - entity_id:
    - sensor.cumulus_2
    trigger: numeric_state
    for:
      hours: 0
      minutes: 1
      seconds: 0
    id: fin
    below: 5
  conditions: []
  actions:
  - if:
    - condition: trigger
      id:
      - debut
    then:
    - metadata: {}
      data: {}
      target:
        entity_id: input_boolean.ecs
      action: input_boolean.turn_on
    - action: automation.trigger
      metadata: {}
      data:
        skip_condition: true
      target:
        entity_id: automation.desactiver_batterie
      enabled: false
    else:
    - metadata: {}
      data: {}
      target:
        entity_id: input_boolean.ecs
      action: input_boolean.turn_off
    - action: automation.trigger
      metadata: {}
      data:
        skip_condition: true
      target:
        entity_id: automation.activer_batterie
      enabled: false
  mode: single
- id: '1720013652767'
  alias: Début Prise Salon
  description: ''
  triggers:
  - entity_id:
    - switch.lumiere_salon
    to: 'on'
    trigger: state
  conditions:
  - condition: state
    entity_id: input_boolean.prise_salon
    state: 'off'
  actions:
  - metadata: {}
    data: {}
    target:
      entity_id: input_boolean.prise_salon
    action: input_boolean.turn_on
  mode: single
- id: '1720013745679'
  alias: Fin Prise Salon
  description: ''
  triggers:
  - entity_id:
    - switch.lumiere_salon
    to: 'off'
    trigger: state
  conditions:
  - condition: state
    entity_id: input_boolean.prise_salon
    state: 'on'
  actions:
  - target:
      entity_id:
      - input_boolean.prise_salon
    data: {}
    action: input_boolean.turn_off
  mode: single
- id: '1720778515127'
  alias: Suppression données EcoJoko
  description: Suppression données EcoJoko
  triggers:
  - at: 00:04:00
    trigger: time
  conditions: []
  actions:
  - data:
      entity_id:
      - sensor.ecojoko_consommation_reseau
      keep_days: 1
    action: recorder.purge_entities
  - action: shell_command.supp_ecojoko
    data: {}
    response_variable: Count
    enabled: false
  mode: single
- id: '1720780669285'
  alias: Suppression données (purge recorder)
  description: Suppression données quotidiennes
  triggers:
  - at: 00:02:00
    trigger: time
  conditions: []
  actions:
  - data:
      keep_days: 1
      entity_id:
      - sensor.consommation_suivie
      - sensor.four
      - sensor.prises_rdc
      - sensor.prises_rdc_2
      - sensor.em06_01_b1
      - sensor.salon_jour
      - sensor.energie_reseau_absolue
      - sensor.em06_02_b1
      - sensor.hauteur_pellets
      - sensor.esphome_web_a92940_marstek_ac_power
      - sensor.decharge_batterie
      - sensor.charge_batterie
      - sensor.rain_sensor_illuminance
      - sensor.rain_sensor_illuminance_average_20min
      - sensor.esphome_web_a92940_marstek_ac_voltage
      - sensor.energie_generale
      - sensor.shelly_em0_voltage
    action: recorder.purge_entities
  - delay:
      hours: 0
      minutes: 1
      seconds: 0
      milliseconds: 0
  - data:
      keep_days: 1
      domains:
      - climate
      - automation
      - device_tracker
      entity_globs:
      - switch.clim_*_xfan
      - switch.clim_*_quiet
      - switch.clim_*_panel_light
      - switch.clim_*_fresh_air
      - sensor.*frequence*
      - sensor.*voltage*
      - sensor.*tension*
      - sensor.*courant*
      - sensor.*current*
      - sensor.energie_consommee*
      - sensor.energy_total*
      - sensor.system_monitor*
      - sensor.m5*
      - sensor.*power_factor*
      - sensor.em06*
      - sensor.*_temps_daller_retour_*
      - sensor.energie_solar*
      - sensor.conso_mini*
      - sensor.*linkquality
      - sensor.shelly*apparent_power
      - sensor.energie_radiateur*
      - sensor.home_assistant*
      - sensor.awtrix*
      - sensor.tp_link_router_*
      - sensor.*rssi*
      - sensor.*retour_maximum
      - switch.*wifi*
      - sensor.estar*
      - sensor.gs108e*
      - sensor.qemu*
      - sensor.*host_001*
      - sensor.shelly*temperature
      - sensor.bbox*
      - sensor.*vu_pour_la_derniere_fois
      - binary_sensor.*_motion_sensor
      - sensor.mesureur_*
      - sensor.em06*power
      - sensor.disjoncteur*
      - sensor.bidirectional_energy_meter*
      - sensor.shelly_*_power
      - sensor.shelly_*_power*
      - sensor.puissance*
      - sensor.*consommation*
      - sensor.*marstek*
      - number.*marstek*
      - light.*marstek*
      - sensor.*production*
    action: recorder.purge_entities
  - delay:
      hours: 0
      minutes: 1
      seconds: 0
      milliseconds: 0
  - data:
      entity_id:
      - sensor.consommation_non_suivie_moyenne
      - sensor.consommation_non_suivie
      - sensor.taux_solar_heure
      - sensor.taux_solar_jour
      - sensor.conso_mini
      - sensor.cumulus_3
      - sensor.esphome_web_27f580_ultrasonic_sensor
      - sensor.batterie_decharge_moyenne
      - sensor.batterie_charge_moyenne
      - sensor.estimation_temps_restant_batterie
      - sensor.puissance_socle
      - sensor.puissance_suivie
      - sensor.esphome_web_a92940_wifi_signal_strength
      - sensor.shelly_em0_total_active_energy
      - sensor.four
      - sensor.esphome_web_a92940_marstek_ac_current
      - sensor.marstek_efficiency
      - sensor.energie_estimee_batterie_dc
      keep_days: 0
    action: recorder.purge_entities
  mode: single
- id: '1725127533248'
  alias: Début Four
  description: ''
  triggers:
  - entity_id:
    - sensor.em06_b2_power
    above: 10
    trigger: numeric_state
  conditions:
  - condition: state
    entity_id: input_boolean.four
    state: 'off'
  actions:
  - metadata: {}
    data: {}
    action: input_boolean.turn_on
    target:
      entity_id: input_boolean.four
  mode: single
- id: '1725127649202'
  alias: Fin Four
  description: ''
  triggers:
  - entity_id:
    - sensor.em06_b2_power
    below: 10
    trigger: numeric_state
  conditions:
  - condition: state
    entity_id: input_boolean.four
    state: 'on'
  actions:
  - data: {}
    action: input_boolean.turn_off
    target:
      entity_id: input_boolean.four
  mode: single
- id: '1725223267378'
  alias: Alerte TV non éteinte
  description: ''
  trigger:
  - platform: time
    at: 00:30:00
  condition:
  - condition: numeric_state
    entity_id: sensor.prise_tv_puissance
    above: 1
  - condition: numeric_state
    entity_id: sensor.prise_tv_cloud_puissance
    above: 1
  action:
  - data:
      message: 'TV non éteinte : {{states(''sensor.prise_tv_puissance'')}}W'
    action: notify.notify
  - action: switch.turn_off
    target:
      device_id:
      - ccfd320c2ae171b9cbca0e8d97e04e9d
    data: {}
  mode: single
- id: '1725794082259'
  alias: Début Plaque
  description: ''
  triggers:
  - entity_id:
    - sensor.em06_a2_power
    above: 10
    trigger: numeric_state
  conditions: []
  actions:
  - metadata: {}
    data: {}
    action: input_boolean.turn_on
    target:
      entity_id:
      - input_boolean.plaque
  mode: single
- id: '1725794111545'
  alias: Fin Plaque
  description: ''
  triggers:
  - entity_id:
    - sensor.em06_a2_power
    below: 10
    trigger: numeric_state
  conditions: []
  actions:
  - data: {}
    action: input_boolean.turn_off
    target:
      entity_id: input_boolean.plaque
  mode: single
- id: '1725825034602'
  alias: Alerte Tuya Local
  description: ''
  triggers:
  - entity_id:
    - sensor.cumulus_3
    for:
      hours: 0
      minutes: 5
      seconds: 0
    trigger: state
  - entity_id:
    - sensor.disjoncteur_sonnette_local_tension
    for:
      hours: 0
      minutes: 5
      seconds: 0
    trigger: state
    enabled: false
  - entity_id:
    - sensor.disjoncteur_3_local_tension
    for:
      hours: 0
      minutes: 5
      seconds: 0
    trigger: state
  - entity_id:
    - sensor.disjoncteur_4_tension_2
    for:
      hours: 0
      minutes: 5
      seconds: 0
    trigger: state
  - entity_id:
    - sensor.disjoncteur_5_local_tension
    for:
      hours: 0
      minutes: 5
      seconds: 0
    trigger: state
    enabled: false
  - entity_id:
    - sensor.mesureur_n1_local_tension
    for:
      hours: 0
      minutes: 5
      seconds: 0
    trigger: state
    enabled: true
  - entity_id:
    - sensor.mesureur_n2_local_tension
    for:
      hours: 0
      minutes: 5
      seconds: 0
    trigger: state
    enabled: true
  - entity_id:
    - sensor.prise_frigo_local_tension
    for:
      hours: 0
      minutes: 5
      seconds: 0
    trigger: state
  - entity_id:
    - sensor.prise_lave_linge_local_tension
    for:
      hours: 0
      minutes: 5
      seconds: 0
    trigger: state
    enabled: false
  - entity_id:
    - sensor.prise_lave_vaiselle_local_tension
    for:
      hours: 0
      minutes: 5
      seconds: 0
    trigger: state
  - entity_id:
    - sensor.prise_tv_local_tension
    for:
      hours: 0
      minutes: 5
      seconds: 0
    trigger: state
  conditions: []
  actions:
  - action: homeassistant.reload_config_entry
    metadata: {}
    data: {}
    target:
      entity_id: '{{ trigger.entity_id }}'
  - delay:
      hours: 0
      minutes: 2
      seconds: 0
  - if:
    - condition: template
      value_template: '{{is_state(trigger.entity_id,''unknown'') or is_state(trigger.entity_id,''unavailable'')}}'
    then:
    - action: notify.persistent_notification
      metadata: {}
      data:
        title: Tuya Local
        message: 'Pas de réponse de {{ trigger.to_state.name.split('' '')[0] }} {{
          trigger.to_state.name.split('' '')[1] }} : {{states(trigger.entity_id)}}'
    - action: notify.notify
      metadata: {}
      data:
        title: Tuya Local
        message: 'Pas de réponse de {{ trigger.to_state.name.split('' '')[0] }} {{
          trigger.to_state.name.split('' '')[1] }} : {{states(trigger.entity_id)}}'
  mode: single
- id: '1725956019083'
  alias: Alerte EcoJoko
  description: ''
  triggers:
  - entity_id:
    - sensor.ecojoko
    for:
      hours: 0
      minutes: 15
      seconds: 0
    trigger: state
    to: unavailable
  - entity_id:
    - sensor.ecojoko
    for:
      hours: 0
      minutes: 15
      seconds: 0
    trigger: state
    to: unknown
  conditions: []
  actions:
  - data:
      message: Pas de réponse d'EcoJoko !
    action: notify.notify
  - action: homeassistant.reload_config_entry
    metadata: {}
    data: {}
    target:
      device_id: 4b74478c94d963f91d4fb4c038530cf7
  mode: single
- id: '1725956270150'
  alias: Alerte Refoss
  description: ''
  triggers:
  - entity_id:
    - sensor.em06_02_a2_power
    for:
      hours: 0
      minutes: 15
      seconds: 0
    trigger: state
  conditions: []
  actions:
  - data:
      message: Pas de réponse de Refoss !
    action: notify.notify
  - action: homeassistant.reload_config_entry
    metadata: {}
    data: {}
    target:
      device_id:
      - 551a4cec52ce5ec5f96436a57efb7e39
      - 70241aa2125233db1ee21cb73c58a47a
  mode: single
- id: '1726580346858'
  alias: Alerte Tuya Cloud
  description: ''
  triggers:
  - entity_id:
    - sensor.disjoncteur_cumulus_tension
    for:
      hours: 0
      minutes: 30
      seconds: 0
    trigger: state
  conditions: []
  actions:
  - action: homeassistant.reload_config_entry
    target:
      label_id: tuya_cloud
    data: {}
  - delay:
      hours: 0
      minutes: 2
      seconds: 0
  - if:
    - condition: or
      conditions:
      - condition: state
        entity_id: sensor.disjoncteur_cumulus_tension
        state: unavailable
      - condition: state
        entity_id: sensor.disjoncteur_cumulus_tension
        state: unknown
    then:
    - action: notify.persistent_notification
      data:
        message: Pas de réponse de Tuya Cloud !
    - data:
        message: Pas de réponse de Tuya Cloud !
      action: notify.notify
    - delay:
        hours: 0
        minutes: 5
        seconds: 0
  mode: single
- id: '1726659595098'
  alias: 'Alerte fonctionnement Frigo '
  description: ''
  triggers:
  - entity_id:
    - input_boolean.frigo
    for:
      hours: 4
      minutes: 0
      seconds: 0
    trigger: state
  conditions: []
  actions:
  - data:
      message: Pas de démarrage du Frigo pendant 4h !
    action: notify.notify
  - delay:
      hours: 0
      minutes: 5
      seconds: 0
      milliseconds: 0
  mode: single
- id: '1726759242515'
  alias: Solcast update
  description: ''
  trigger:
  - platform: template
    value_template: "{% set nr = as_datetime(state_attr('sun.sun','next_rising'))
      | as_local %} {% set ns = as_datetime(state_attr('sun.sun','next_setting'))
      | as_local %} {% set api_request_limit = 10 %} {% if nr > ns %}\n  {% set nr
      = nr - timedelta(hours = 24) %} \n{% endif %} {% set hours_difference = (ns
      - nr) %} {% set interval_hours = hours_difference / api_request_limit %} {%
      set ns = namespace(match = false) %} {% for i in range(api_request_limit) %}\n
      \ {% set start_time = nr + (i * interval_hours) %}\n  {% if ((start_time - timedelta(seconds=30))
      <= now()) and (now() <= (start_time + timedelta(seconds=30))) %}\n    {% set
      ns.match = true %}\n  {% endif %}\n{% endfor %} {{ ns.match }}"
  condition:
  - condition: sun
    before: sunset
    after: sunrise
  action:
  - delay:
      seconds: '{{ range(30, 360)|random|int }}'
  - data: {}
    action: solcast_solar.update_forecasts
  mode: single
- id: '1727031043968'
  alias: Début Lumières RDC
  description: ''
  triggers:
  - entity_id:
    - sensor.em06_c2_power
    above: 0
    trigger: numeric_state
  conditions:
  - condition: state
    entity_id: input_boolean.lumieres_rdc
    state: 'off'
  actions:
  - metadata: {}
    data: {}
    action: input_boolean.turn_on
    target:
      entity_id: input_boolean.lumieres_rdc
  mode: single
- id: '1727031116637'
  alias: Début Lumières Étage
  description: ''
  triggers:
  - entity_id:
    - sensor.bidirectional_energy_meter_power_b
    above: 0
    trigger: numeric_state
  conditions:
  - condition: state
    entity_id: input_boolean.lumieres_etage
    state: 'off'
  actions:
  - metadata: {}
    data: {}
    action: input_boolean.turn_on
    target:
      entity_id: input_boolean.lumieres_etage
  mode: single
- id: '1727031227421'
  alias: Début Prises Etage
  description: ''
  triggers:
  - entity_id:
    - sensor.bidirectional_energy_meter_power_a
    above: 0
    trigger: numeric_state
  conditions:
  - condition: state
    entity_id: input_boolean.prises_etage
    state: 'off'
  actions:
  - metadata: {}
    data: {}
    action: input_boolean.turn_on
    target:
      entity_id: input_boolean.prises_etage
  mode: single
- id: '1727040109754'
  alias: Fin Lumières Etage
  description: ''
  trigger:
  - platform: numeric_state
    entity_id:
    - sensor.bidirectional_energy_meter_power_b
    below: 1
  condition: []
  action:
  - action: input_boolean.turn_off
    target:
      entity_id:
      - input_boolean.lumieres_etage
    data: {}
  mode: single
- id: '1727040145674'
  alias: Fin Lumières RDC
  description: ''
  triggers:
  - entity_id:
    - sensor.em06_c2_power
    below: 1
    trigger: numeric_state
  conditions: []
  actions:
  - action: input_boolean.turn_off
    target:
      entity_id:
      - input_boolean.lumieres_rdc
    data: {}
  mode: single
- id: '1727040181229'
  alias: Fin Prises Etage
  description: ''
  triggers:
  - entity_id:
    - sensor.bidirectional_energy_meter_power_a
    below: 1
    trigger: numeric_state
    for:
      hours: 0
      minutes: 1
      seconds: 0
  conditions:
  - condition: state
    entity_id: input_boolean.prises_etage
    state: 'on'
  actions:
  - action: input_boolean.turn_off
    target:
      entity_id:
      - input_boolean.prises_etage
    data: {}
  mode: single
- id: '1727100872708'
  alias: Passage HC
  description: ''
  trigger:
  - platform: time
    at: '21:08:00'
  action:
  - data:
      option: HC
    action: select.select_option
    target:
      entity_id:
      - select.energie_consommee_h
      - select.energie_consommee_j
      - select.energie_consommee_s
      - select.energie_consommee_m
      - select.energie_consommee_a
  - action: input_boolean.turn_on
    target:
      entity_id: input_boolean.hp_hc
    data: {}
  initial_state: true
- id: '1727101009222'
  alias: Passage HP
  description: ''
  trigger:
  - platform: time
    at: 05:08:00
  condition: []
  action:
  - data:
      option: HP
    action: select.select_option
    target:
      entity_id:
      - select.energie_consommee_h
      - select.energie_consommee_j
      - select.energie_consommee_s
      - select.energie_consommee_m
      - select.energie_consommee_a
  - action: input_boolean.turn_off
    target:
      entity_id: input_boolean.hp_hc
    data: {}
  mode: single
  initial_state: true
- id: '1727103070490'
  alias: Energie - Notification
  description: ''
  triggers:
  - at: 00:01:00
    trigger: time
  actions:
  - data_template:
      title: 'Données Energie du {{ as_timestamp(now()) | timestamp_custom("%d.%m.%y",
        True) }}

        '
      message: 'HC : {{ states(''input_number.taux_hc_j_1'') | round(1) }} %. Conso
        : {{states(''input_number.energie_j_1'') | round(2) }} kWh / {{states(''input_number.cout_energie_j_1'')
        | round(2)  }}€

        ECS : {{ (states(''sensor.cumulus_kwh'')| float(0) - states(''input_number.energie_cumulus_jour'')
        | float(0))| round(2)}} kWh / Surplus : {{ (states(''input_number.surplus_production_j_1'')
        | float(0)) | round(2) }} kWh

        Prod : {{ (states(''input_number.solar_production_j_1'') | float) | round(2)
        }} kWh / {{states(''input_number.solar_previsions_j_1'') | round(1) }} kWh
        ({{ states(''input_number.taux_solar_j_1'') | round(1) }} %)

        Demain : {{states(''sensor.solcast_pv_forecast_previsions_pour_aujourd_hui'')
        | round(1)}} kWh / max {{states(''sensor.solcast_pv_forecast_previsions_du_pic_aujourd_hui'')
        | round(0)}} W à {{ as_timestamp(states(''sensor.solcast_pv_forecast_heure_du_pic_aujourd_hui''))
        | timestamp_custom("%Hh%M", True) }}. Météo : {{states(''sensor.talence_daily_original_condition'')}}

        '
    action: notify.notify
  - data_template:
      title: 'Données Energie du {{ as_timestamp(now()) | timestamp_custom("%d.%m.%y",
        True) }}

        '
      message: "Taux HC du jour : {{ states('input_number.taux_hc_j_1') | round(1)
        }} %.\n\nConsommation de la journée : {{states('input_number.energie_j_1')
        | round(2) }} kWh / {{states('input_number.cout_energie_j_1') | round(2)  }}€
        \n\nSurplus : {{ (states('input_number.surplus_production_j_1') | float(0))
        | round(2) }} kWh pour  {{ (states('input_number.prix_vente_edf_oa') | float(0)
        * states('input_number.surplus_production_j_1') | float(0)) | round(2) }}
        €\n"
    action: notify.persistent_notification
  - data_template:
      entity_id: input_number.energie_cumulus_jour
      value: '{{ states(''sensor.cumulus_kwh'') | float }}'
    action: input_number.set_value
    enabled: true
  mode: single
- id: '1727255726386'
  alias: Energie - Calcul
  description: ''
  triggers:
  - at: '23:59:50'
    trigger: time
  conditions: []
  actions:
  - data_template:
      entity_id: input_number.energie_j_1
      value: '{{float(states(''sensor.ecojoko_consommation_reseau''),0) | round(2)}}'
    action: input_number.set_value
  - data_template:
      entity_id: input_number.cout_energie_j_1
      value: '{{(float(states(''sensor.ecojoko_consommation_hc_reseau''),0)*float(states(''input_number.prix_hc_kwh''),0)+float(states(''sensor.ecojoko_consommation_hp_reseau''),0)*float(states(''input_number.prix_hp_kwh''),0))
        | round(2)}}'
    action: input_number.set_value
  - data_template:
      entity_id: input_number.taux_hc_j_1
      value: '{{ float(states(''sensor.taux_hc_jour''),0) | round(1)}}'
    action: input_number.set_value
  - data_template:
      entity_id: input_number.solar_previsions_j_1
      value: '{{ states(''sensor.solcast_pv_forecast_previsions_pour_aujourd_hui'')
        | float | round(1)}}'
    action: input_number.set_value
  - data_template:
      entity_id: input_number.solar_production_j_1
      value: '{{ float(states(''sensor.energie_solar_j''),0) | round(1)}}'
    action: input_number.set_value
  - data_template:
      entity_id: input_number.taux_solar_j_1
      value: '{{ float(states(''sensor.taux_solar_jour''),0) | round(1)}}'
    action: input_number.set_value
  - data_template:
      entity_id: input_number.surplus_production_j_1
      value: '{{ float(states(''sensor.surplus_production_compteur''),0)| round(1)}}'
    action: input_number.set_value
  mode: single
- id: '1727278237568'
  alias: Energie - Calcul (h)
  description: ''
  trigger:
  - platform: time_pattern
    hours: '*'
    minutes: '59'
    seconds: '55'
  condition: []
  action:
  - data_template:
      entity_id: input_number.solar_previsions_h_1
      value: '{{ states(''sensor.solcast_pv_forecast_previsions_heure_actuel'') |
        float | round(0)}}'
    action: input_number.set_value
  - data_template:
      entity_id: input_number.solar_production_h_1
      value: '{{ states(''sensor.energie_solar_h'') | float | round(0)}}'
    action: input_number.set_value
  - data_template:
      entity_id: input_number.taux_solar_h_1
      value: '{{ states(''sensor.taux_solar_heure'') | float | round(1)}}'
    action: input_number.set_value
  mode: single
- id: '1727467947113'
  alias: Reset Compteurs
  description: ''
  trigger:
  - platform: time
    at: 00:00:00
  condition: []
  action:
  - action: utility_meter.reset
    metadata: {}
    data: {}
    target:
      entity_id:
      - select.energie_consommee_a
      - select.energie_consommee_m
      - select.energie_consommee_s
  mode: single
- id: '1727558860632'
  alias: Reload integration on startup
  description: ''
  triggers:
  - event: start
    trigger: homeassistant
  actions:
  - delay:
      hours: 0
      minutes: 1
      seconds: 0
      milliseconds: 0
  - action: shell_command.energie_solar
  - action: rest.reload
    data: {}
  mode: single
- id: '1727901329718'
  alias: Alerte Tahoma
  description: ''
  triggers:
  - entity_id:
    - switch.lumiere_salon
    for:
      hours: 0
      minutes: 5
      seconds: 0
    trigger: state
    to: unavailable
  conditions: []
  actions:
  - data:
      message: Pas de réponse de Tahoma !
    action: notify.notify
  - action: homeassistant.reload_config_entry
    metadata: {}
    data: {}
    target:
      entity_id: switch.lumiere_salon
  - delay:
      hours: 0
      minutes: 5
      seconds: 0
      milliseconds: 0
  mode: single
- id: '1727989585410'
  alias: Alerte SwitchBot
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - sensor.switchbot_cloud
    to: unavailable
    for:
      hours: 0
      minutes: 5
      seconds: 0
  - entity_id:
    - sensor.switchbot_cloud
    for:
      hours: 1
      minutes: 0
      seconds: 0
    trigger: state
  conditions: []
  actions:
  - data:
      message: Pas de réponse de SwitchBot ! {{trigger.from_state.attributes.friendly_name
        }}
    action: notify.notify
  - action: notify.persistent_notification
    data:
      message: Pas de réponse de SwitchBot ! {{trigger.from_state.attributes.friendly_name
        }}
  - action: homeassistant.reload_config_entry
    data:
      entry_id: 01J8DKMC9KWGY1GD1EFXCC2QG2
  mode: single
- id: '1727989940257'
  alias: Bilan Solaire
  description: ''
  triggers:
  - trigger: sun
    event: sunset
    offset: 00:00:00
    enabled: false
  - trigger: numeric_state
    entity_id:
    - sensor.production_solaire
    for:
      hours: 0
      minutes: 15
      seconds: 0
    below: 1
  actions:
  - data_template:
      title: 'Données Solaire du {{ as_timestamp(now()) | timestamp_custom("%d.%m.%y",
        True) }}

        '
      message: "\nTaux de prévision solaire : {{ states('sensor.taux_solar_jour')
        | float | round(1)}} %. \n\nProduction solaire : {{ (states('sensor.energie_solar_j')
        | float) | float | round(2)}} kWh / {{ states('sensor.solcast_pv_forecast_previsions_pour_aujourd_hui')
        | float | round(2)}} kWh prévus.\nAutoconsommation : {{ (((states('sensor.energie_solar_j')
        | float(0)- states('sensor.surplus_production_compteur') | float(0) ) / (states('sensor.energie_solar_j')
        | float(0)+0.0001) ) * 100) | round(0)}} %.\nSurplus solaire : {{ (states('sensor.surplus_production_compteur')
        | float(0))| round(2)}} kWh / {{ (states('sensor.surplus_production_compteur')
        | float(0) * states('input_number.prix_vente_edf_oa') | float(0)) | round(2)}}
        €. \nChauffe-eau : {{ (states('sensor.cumulus_kwh')| float(0) - states('input_number.energie_cumulus_jour')
        | float(0))| round(2)}} kWh.\n\nDemain, il est prévu : {{states('sensor.solcast_pv_forecast_previsions_pour_demain')
        | round(1)}} kWh / max  {{states('sensor.solcast_pv_forecast_previsions_du_pic_pour_demain')
        | round(0)}} W à {{ as_timestamp(states('sensor.solcast_pv_forecast_heure_du_pic_demain'))
        | timestamp_custom(\"%Hh%M\", True) }}.\n"
    action: notify.persistent_notification
    enabled: true
  - data_template:
      title: 'Données Solaire du {{ as_timestamp(now()) | timestamp_custom("%d.%m.%y",
        True) }}

        '
      message: 'Solaire : {{ states(''sensor.taux_solar_jour'') | round(1) }} %. Prod
        : {{ (states(''sensor.energie_solar_j'') | float) | round(2) }} kWh / {{states(''sensor.solcast_pv_forecast_previsions_pour_aujourd_hui'')
        | round(1) }} kWh.  Autoconsommation : {{ (((states(''sensor.energie_solar_j'')
        | float(0)- states(''sensor.surplus_production_compteur'') | float(0) ) /
        (states(''sensor.energie_solar_j'') | float(0)+0.0001)) * 100) | round(0)}}
        %. Surplus solaire : {{ (states(''sensor.surplus_production_compteur'') |
        float(0))| round(2)}} kWh / {{ (states(''sensor.surplus_production_compteur'')
        | float(0) * states(''input_number.prix_vente_edf_oa'') | float(0)) | round(2)}}
        €. Chauffe-eau : {{ (states(''sensor.cumulus_kwh'')| float(0) - states(''input_number.energie_cumulus_jour'')
        | float(0))| round(2)}} kWh.


        Demain : {{states(''sensor.solcast_pv_forecast_previsions_pour_demain'') |
        round(1)}} kWh / max  {{states(''sensor.solcast_pv_forecast_previsions_du_pic_pour_demain'')
        | round(0)}} W à {{ as_timestamp(states(''sensor.solcast_pv_forecast_heure_du_pic_demain''))
        | timestamp_custom("%Hh%M", True) }}.

        '
    action: notify.notify
    enabled: true
- id: '1728387375442'
  alias: Alerte Garage absence
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - cover.porte_garage
    to: opening
  conditions:
  - condition: and
    conditions:
    - condition: not
      conditions:
      - condition: state
        state: home
        entity_id: person.marine
    - condition: not
      conditions:
      - condition: state
        state: home
        entity_id: device_tracker.iphone_de_mat_13
  actions:
  - action: notify.notify
    data:
      message: Alerte ouverture garage !
  mode: single
- id: '1728655435449'
  alias: Alerte Météo
  description: ''
  triggers:
  - entity_id:
    - weather.talence
    for:
      hours: 0
      minutes: 5
      seconds: 0
    trigger: state
    to: unavailable
  conditions: []
  actions:
  - action: notify.persistent_notification
    data:
      message: Pas de réponse de Météo
  - action: homeassistant.reload_config_entry
    metadata: {}
    data: {}
    target:
      entity_id: weather.talence
  - delay:
      hours: 0
      minutes: 5
      seconds: 0
      milliseconds: 0
  mode: single
- id: '1730232489877'
  alias: Mise à jour token Estar
  description: ''
  triggers:
  - trigger: time_pattern
    minutes: '5'
  conditions: []
  actions:
  - action: input_text.set_value
    metadata: {}
    data:
      value: estar_token={{state_attr('sensor.estar_token','token')}}
    target:
      entity_id: input_text.estar_token_input
  mode: single
- id: '1730501750728'
  alias: WLED Conso
  description: ''
  triggers:
  - trigger: time_pattern
    minutes: /1
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: numeric_state
        entity_id: sensor.em06_02_a2_power
        below: 100
      sequence:
      - action: select.select_option
        target:
          entity_id: select.wled1_prereglage
        data:
          option: Prod100
    - conditions:
      - condition: numeric_state
        entity_id: sensor.em06_02_a2_power
        below: 200
      sequence:
      - action: select.select_option
        target:
          entity_id: select.wled1_prereglage
        data:
          option: Prod200
    - conditions:
      - condition: numeric_state
        entity_id: sensor.em06_02_a2_power
        below: 300
      sequence:
      - action: select.select_option
        target:
          entity_id: select.wled1_prereglage
        data:
          option: Prod300
    - conditions:
      - condition: numeric_state
        entity_id: sensor.em06_02_a2_power
        below: 400
      sequence:
      - action: select.select_option
        target:
          entity_id: select.wled1_prereglage
        data:
          option: Prod400
    - conditions:
      - condition: numeric_state
        entity_id: sensor.em06_02_a2_power
        below: 500
      sequence:
      - action: select.select_option
        target:
          entity_id: select.wled1_prereglage
        data:
          option: Prod500
    - conditions:
      - condition: numeric_state
        entity_id: sensor.em06_02_a2_power
        below: 750
      sequence:
      - action: select.select_option
        target:
          entity_id: select.wled1_prereglage
        data:
          option: Prod750
    - conditions:
      - condition: numeric_state
        entity_id: sensor.em06_02_a2_power
        below: 1000
      sequence:
      - action: select.select_option
        target:
          entity_id: select.wled1_prereglage
        data:
          option: Prod1000
    - conditions:
      - condition: numeric_state
        entity_id: sensor.em06_02_a2_power
        below: 1500
      sequence:
      - action: select.select_option
        target:
          entity_id: select.wled1_prereglage
        data:
          option: Prod1500
    - conditions:
      - condition: numeric_state
        entity_id: sensor.em06_02_a2_power
        below: 2000
      sequence:
      - action: select.select_option
        target:
          entity_id: select.wled1_prereglage
        data:
          option: Prod2000
    - conditions:
      - condition: numeric_state
        entity_id: sensor.em06_02_a2_power
        below: 2500
      sequence:
      - action: select.select_option
        target:
          entity_id: select.wled1_prereglage
        data:
          option: Prod2500
    - conditions:
      - condition: numeric_state
        entity_id: sensor.em06_02_a2_power
        below: 3000
      sequence:
      - action: select.select_option
        target:
          entity_id: select.wled1_prereglage
        data:
          option: Prod3000
    - conditions:
      - condition: numeric_state
        entity_id: sensor.em06_02_a2_power
        above: 3000
      sequence:
      - action: select.select_option
        target:
          entity_id: select.wled1_prereglage
        data:
          option: ProdMax
  - delay:
      hours: 0
      minutes: 1
      seconds: 0
      milliseconds: 0
  mode: single
- id: '1730799442676'
  alias: Alerte TP-Link
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - sensor.tp_link_router_cpu_used
    for:
      hours: 0
      minutes: 4
      seconds: 0
  - trigger: state
    entity_id:
    - sensor.tp_link_router_cpu_used
    to: unavailable
    for:
      hours: 0
      minutes: 1
      seconds: 0
  - trigger: state
    entity_id:
    - sensor.tp_link_router_cpu_used
    to: unknown
    for:
      hours: 0
      minutes: 1
      seconds: 0
  conditions: []
  actions:
  - repeat:
      sequence:
      - action: homeassistant.reload_config_entry
        metadata: {}
        data: {}
        target:
          device_id: 9b77fab7a9aa7b4577e7cfe2d53e7375
      - wait_for_trigger:
        - trigger: template
          value_template: '{{ float(states(''sensor.tp_link_router_cpu_used''),0)
            > 0 }}'
        timeout:
          hours: 0
          minutes: 5
          seconds: 0
          milliseconds: 0
      while:
      - condition: template
        value_template: '{{ (is_state(''sensor.tp_link_router_cpu_used'', ''unavailable'')
          or is_state(''sensor.tp_link_router_cpu_used'', ''unknown'')) and repeat.index
          < 6 }}'
  - if:
    - condition: or
      conditions:
      - condition: state
        entity_id: sensor.tp_link_router_cpu_used
        state: unavailable
      - condition: state
        entity_id: sensor.tp_link_router_cpu_used
        state: unknown
    then:
    - action: notify.persistent_notification
      metadata: {}
      data:
        message: 'Pas de réponse de TP Link ! '
  mode: single
- id: '1730987726595'
  alias: Alerte Rain Sensor
  description: ''
  triggers:
  - entity_id:
    - sensor.rain_sensor_linkquality
    for:
      hours: 0
      minutes: 30
      seconds: 0
    trigger: state
  - entity_id:
    - sensor.prise_zigbee_1_linkquality
    for:
      hours: 0
      minutes: 30
      seconds: 0
    trigger: state
  conditions: []
  actions:
  - data:
      message: Pas de réponse de {{ trigger.to_state.name | replace(' Linkquality','')
        }} !
    action: notify.persistent_notification
  - action: notify.notify
    metadata: {}
    data:
      message: Pas de réponse de {{ trigger.to_state.name | replace(' Linkquality','')
        }} !
  - delay:
      hours: 0
      minutes: 5
      seconds: 0
      milliseconds: 0
  mode: single
- id: '1731062182492'
  alias: Alerte Token Estar
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - sensor.estar_url
    to: token verify error.
    for:
      hours: 0
      minutes: 5
      seconds: 0
  - trigger: state
    entity_id:
    - sensor.estar_centrale
    to: unavailable
    for:
      hours: 0
      minutes: 5
      seconds: 0
  conditions: []
  actions:
  - action: rest.reload
    metadata: {}
    data: {}
  - delay:
      hours: 0
      minutes: 0
      seconds: 10
      milliseconds: 0
  - action: input_text.set_value
    metadata: {}
    data:
      value: estar_token={{state_attr('sensor.estar_token','token')}}
    target:
      entity_id: input_text.estar_token_input
  - if:
    - condition: state
      entity_id: sensor.estar_url
      state: success
    then: []
    else:
    - action: notify.persistent_notification
      metadata: {}
      data:
        message: MAJ Token Estar NOK
  mode: single
- id: '1731443950550'
  alias: 'Activation routeur solaire '
  description: ''
  triggers:
  - trigger: numeric_state
    entity_id:
    - sensor.surplus_production
    for:
      hours: 0
      minutes: 1
      seconds: 0
    above: 100
  conditions:
  - condition: and
    conditions:
    - condition: state
      entity_id: input_boolean.automatisation
      state: 'on'
      enabled: false
    - condition: or
      conditions:
      - condition: device
        type: is_off
        device_id: a7f1d9334e2a44ce460f2a4965813ab7
        entity_id: b8187e650ac0c789099d4e8cd0afc449
        domain: switch
      - condition: state
        entity_id: switch.cumulus
        state: 'off'
    - condition: numeric_state
      entity_id: sensor.production_solaire
      above: 200
    - condition: state
      entity_id: input_boolean.mode_absent
      state: 'off'
  actions:
  - if:
    - condition: device
      type: is_off
      device_id: a7f1d9334e2a44ce460f2a4965813ab7
      entity_id: b8187e650ac0c789099d4e8cd0afc449
      domain: switch
    then:
    - action: switch.turn_on
      metadata: {}
      data: {}
      target:
        device_id: a7f1d9334e2a44ce460f2a4965813ab7
  - if:
    - condition: device
      type: is_off
      device_id: 62be3297a0c0d75c708f1a2e49911819
      entity_id: 84ede9c070c6abc84dbd5367e484c988
      domain: switch
    then:
    - type: turn_on
      device_id: 62be3297a0c0d75c708f1a2e49911819
      entity_id: 84ede9c070c6abc84dbd5367e484c988
      domain: switch
  - data_template:
      entity_id: input_number.energie_cumulus_jour
      value: '{{ states(''sensor.cumulus_kwh'') | float }}'
    action: input_number.set_value
    enabled: false
  - if:
    - condition: state
      entity_id: input_boolean.priorite_batterie
      state: 'on'
    then:
    - action: input_boolean.turn_off
      metadata: {}
      data: {}
      target:
        entity_id: input_boolean.priorite_batterie
  - action: notify.notify
    metadata: {}
    data:
      message: Activation du routeur solaire
  mode: single
- id: '1731444544142'
  alias: Désactivation Routeur Solaire
  description: ''
  triggers:
  - trigger: numeric_state
    entity_id:
    - sensor.production_solaire
    for:
      hours: 0
      minutes: 30
      seconds: 0
    below: 1
  conditions: []
  actions:
  - if:
    - condition: and
      conditions:
      - condition: state
        entity_id: input_boolean.automatisation
        state: 'on'
        enabled: false
      - condition: device
        type: is_on
        device_id: a7f1d9334e2a44ce460f2a4965813ab7
        entity_id: b8187e650ac0c789099d4e8cd0afc449
        domain: switch
    then:
    - action: switch.turn_off
      metadata: {}
      data: {}
      target:
        device_id: a7f1d9334e2a44ce460f2a4965813ab7
    - if:
      - condition: state
        entity_id: switch.shelly_plus_1pm_01_relay_0
        state: 'off'
      then:
      - type: turn_off
        device_id: 62be3297a0c0d75c708f1a2e49911819
        entity_id: 84ede9c070c6abc84dbd5367e484c988
        domain: switch
  - action: automation.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: automation.activation_routeur_solaire
  mode: single
- id: '1731688869372'
  alias: Fin chauffage ECS
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - input_boolean.ecs
    to: 'off'
    for:
      hours: 0
      minutes: 0
      seconds: 0
  - trigger: numeric_state
    entity_id:
    - sensor.cumulus_2
    for:
      hours: 0
      minutes: 1
      seconds: 0
    below: 5
  conditions:
  - condition: template
    value_template: '{{float(states(''sensor.sonde_temperature_owon_temperature''),0)>float(states(''input_number.tmax_ecs''),0)-1
      }}'
  actions:
  - if:
    - condition: state
      entity_id: switch.shelly_plus_1pm_01_switch_0
      state: 'on'
    then:
    - type: turn_off
      device_id: 8e3d37afc5f245b797dfafd4bb1f45f7
      entity_id: da17360430fe8b896d3d4b9979d02b99
      domain: switch
  - action: input_boolean.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: input_boolean.ecs_chaud
  - action: input_boolean.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: input_boolean.priorite_batterie
  - action: notify.notify
    metadata: {}
    data:
      message: "Le ballon d'eau chaude est chaud ({{ (float(states('sensor.cumulus_kwh'))-float(states('input_number.energie_cumulus_jour')))
        | round(2) }} kwh - {{states('sensor.sonde_temperature_owon_temperature')}}
        °c)! \n{% if int(states('sensor.surplus_production')) > 0%} Surplus disponible
        : {{int(states('sensor.surplus_production'))}}W.{% endif %} "
  mode: single
- id: '1731688965959'
  alias: Reset ECS Chaud
  description: ''
  triggers:
  - trigger: numeric_state
    entity_id:
    - sensor.sonde_temperature_owon_temperature
    below: 40
  conditions: []
  actions:
  - action: input_boolean.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: input_boolean.ecs_chaud
  mode: single
- id: '1731835608679'
  alias: WLED
  description: ''
  triggers:
  - trigger: homeassistant
    event: start
  conditions: []
  actions:
  - repeat:
      sequence:
      - if:
        - condition: state
          entity_id: light.wled1_principal
          state: 'on'
        - condition: state
          entity_id: input_boolean.automatisation
          state: 'on'
        then:
        - sequence:
          - choose:
            - conditions:
              - condition: numeric_state
                entity_id: sensor.production_solaire
                below: 1
              sequence:
              - action: select.select_option
                target:
                  entity_id: select.wled1_prereglage
                data:
                  option: Prod0
            - conditions:
              - condition: numeric_state
                entity_id: sensor.production_solaire
                below: 100
              sequence:
              - action: select.select_option
                target:
                  entity_id: select.wled1_prereglage
                data:
                  option: Prod100
            - conditions:
              - condition: numeric_state
                entity_id: sensor.production_solaire
                below: 200
              sequence:
              - action: select.select_option
                target:
                  entity_id: select.wled1_prereglage
                data:
                  option: Prod200
            - conditions:
              - condition: numeric_state
                entity_id: sensor.production_solaire
                below: 300
              sequence:
              - action: select.select_option
                target:
                  entity_id: select.wled1_prereglage
                data:
                  option: Prod300
            - conditions:
              - condition: numeric_state
                entity_id: sensor.production_solaire
                below: 400
              sequence:
              - action: select.select_option
                target:
                  entity_id: select.wled1_prereglage
                data:
                  option: Prod400
            - conditions:
              - condition: numeric_state
                entity_id: sensor.production_solaire
                below: 500
              sequence:
              - action: select.select_option
                target:
                  entity_id: select.wled1_prereglage
                data:
                  option: Prod500
            - conditions:
              - condition: numeric_state
                entity_id: sensor.production_solaire
                below: 750
              sequence:
              - action: select.select_option
                target:
                  entity_id: select.wled1_prereglage
                data:
                  option: Prod750
            - conditions:
              - condition: numeric_state
                entity_id: sensor.production_solaire
                below: 1000
              sequence:
              - action: select.select_option
                target:
                  entity_id: select.wled1_prereglage
                data:
                  option: Prod1000
            - conditions:
              - condition: numeric_state
                entity_id: sensor.production_solaire
                below: 1500
              sequence:
              - action: select.select_option
                target:
                  entity_id: select.wled1_prereglage
                data:
                  option: Prod1500
            - conditions:
              - condition: numeric_state
                entity_id: sensor.production_solaire
                below: 2000
              sequence:
              - action: select.select_option
                target:
                  entity_id: select.wled1_prereglage
                data:
                  option: Prod2000
            - conditions:
              - condition: numeric_state
                entity_id: sensor.production_solaire
                below: 2500
              sequence:
              - action: select.select_option
                target:
                  entity_id: select.wled1_prereglage
                data:
                  option: Prod2500
            - conditions:
              - condition: numeric_state
                entity_id: sensor.production_solaire
                below: 3000
              sequence:
              - action: select.select_option
                target:
                  entity_id: select.wled1_prereglage
                data:
                  option: Prod3000
            - conditions:
              - condition: numeric_state
                entity_id: sensor.production_solaire
                above: 3000
              sequence:
              - action: select.select_option
                target:
                  entity_id: select.wled1_prereglage
                data:
                  option: ProdMax
            default:
            - action: select.select_option
              metadata: {}
              data:
                option: Vide Prod
              target:
                entity_id: select.wled1_prereglage
          - choose:
            - conditions:
              - condition: numeric_state
                entity_id: sensor.surplus_production
                below: 1
              sequence:
              - action: select.select_option
                target:
                  entity_id: select.wled1_prereglage
                data:
                  option: Surplus0
            - conditions:
              - condition: numeric_state
                entity_id: sensor.surplus_production
                below: 100
              sequence:
              - action: select.select_option
                target:
                  entity_id: select.wled1_prereglage
                data:
                  option: Surplus100
            - conditions:
              - condition: numeric_state
                entity_id: sensor.surplus_production
                below: 200
              sequence:
              - action: select.select_option
                target:
                  entity_id: select.wled1_prereglage
                data:
                  option: Surplus200
            - conditions:
              - condition: numeric_state
                entity_id: sensor.surplus_production
                below: 300
              sequence:
              - action: select.select_option
                target:
                  entity_id: select.wled1_prereglage
                data:
                  option: Surplus300
            - conditions:
              - condition: numeric_state
                entity_id: sensor.surplus_production
                below: 400
              sequence:
              - action: select.select_option
                target:
                  entity_id: select.wled1_prereglage
                data:
                  option: Surplus400
            - conditions:
              - condition: numeric_state
                entity_id: sensor.surplus_production
                below: 500
              sequence:
              - action: select.select_option
                target:
                  entity_id: select.wled1_prereglage
                data:
                  option: Surplus500
            - conditions:
              - condition: numeric_state
                entity_id: sensor.surplus_production
                below: 750
              sequence:
              - action: select.select_option
                target:
                  entity_id: select.wled1_prereglage
                data:
                  option: Surplus750
            - conditions:
              - condition: numeric_state
                entity_id: sensor.surplus_production
                below: 1000
              sequence:
              - action: select.select_option
                target:
                  entity_id: select.wled1_prereglage
                data:
                  option: Surplus1000
            - conditions:
              - condition: numeric_state
                entity_id: sensor.surplus_production
                below: 1500
              sequence:
              - action: select.select_option
                target:
                  entity_id: select.wled1_prereglage
                data:
                  option: Surplus1500
            - conditions:
              - condition: numeric_state
                entity_id: sensor.surplus_production
                below: 2000
              sequence:
              - action: select.select_option
                target:
                  entity_id: select.wled1_prereglage
                data:
                  option: Surplus2000
            - conditions:
              - condition: numeric_state
                entity_id: sensor.surplus_production
                below: 2500
              sequence:
              - action: select.select_option
                target:
                  entity_id: select.wled1_prereglage
                data:
                  option: Surplus2500
            - conditions:
              - condition: numeric_state
                entity_id: sensor.surplus_production
                below: 3000
              sequence:
              - action: select.select_option
                target:
                  entity_id: select.wled1_prereglage
                data:
                  option: Surplus3000
            - conditions:
              - condition: numeric_state
                entity_id: sensor.surplus_production
                above: 3000
              sequence:
              - action: select.select_option
                target:
                  entity_id: select.wled1_prereglage
                data:
                  option: SurplusMax
            default:
            - action: select.select_option
              metadata: {}
              data:
                option: Vide Surplus
              target:
                entity_id: select.wled1_prereglage
      - delay:
          hours: 0
          minutes: 1
          seconds: 0
          milliseconds: 0
      while:
      - condition: numeric_state
        entity_id: sensor.production_solaire
        above: 0
  mode: single
- id: '1731947570505'
  alias: Activation Clim Salon
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - schedule.calendrier_chauffage_salon
    from: 'off'
    to: 'on'
  conditions:
  - condition: and
    conditions:
    - condition: state
      entity_id: input_boolean.mode_chauffage
      state: 'on'
    - condition: state
      entity_id: input_boolean.automatisation
      state: 'on'
    - condition: state
      entity_id: switch.disjoncteur_4_none
      state: 'off'
    - condition: state
      entity_id: input_boolean.mode_absent
      state: 'off'
  actions:
  - action: switch.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: switch.disjoncteur_4_none
  - action: notify.notify
    metadata: {}
    data:
      message: Activation de la Clim Salon
  mode: single
- id: '1731947660404'
  alias: Désactivation Clim Salon
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - schedule.calendrier_chauffage_salon
    from: 'on'
    to: 'off'
  conditions:
  - condition: and
    conditions:
    - condition: state
      entity_id: input_boolean.automatisation
      state: 'on'
    - condition: state
      entity_id: input_boolean.mode_chauffage
      state: 'on'
    - condition: state
      entity_id: switch.disjoncteur_4_none
      state: 'on'
  actions:
  - if:
    - condition: numeric_state
      entity_id: sensor.disjoncteur_4_puissance_2
      above: 20
    then:
    - action: notify.notify
      metadata: {}
      data:
        message: 'Désactivation impossible de Clim Salon : en cours d''utilisation'
    - wait_template: '{{(states(''sensor.disjoncteur_4_puissance_2'') | int ) < 20
        }}'
      continue_on_timeout: true
    - delay:
        hours: 0
        minutes: 5
        seconds: 0
        milliseconds: 0
    - wait_template: '{{(states(''sensor.disjoncteur_4_puissance_2'') | int ) < 20
        }}'
      continue_on_timeout: true
  - action: switch.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: switch.disjoncteur_4_none
  - action: notify.notify
    metadata: {}
    data:
      message: Désactivation de Clim Salon
  mode: single
- id: '1731971598661'
  alias: Alerte Radiateur
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - sensor.em06_02_b1_power
    for:
      hours: 0
      minutes: 1
      seconds: 0
  conditions: []
  actions:
  - action: fan.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: fan.esp32_pwm
  mode: single
- id: '1732521992660'
  alias: Activation Prises connectées
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - schedule.calendrier_chauffage_salon
    from: 'off'
    to: 'on'
  conditions:
  - condition: state
    entity_id: input_boolean.automatisation
    state: 'on'
  - condition: state
    entity_id: input_boolean.mode_absent
    state: 'off'
  actions:
  - parallel:
    - if:
      - condition: state
        entity_id: switch.disjoncteur_3_local
        state: 'off'
      - condition: state
        entity_id: input_boolean.mode_chauffage
        state: 'on'
      then:
      - action: switch.turn_on
        metadata: {}
        data: {}
        target:
          device_id:
          - 2e6fb60152117ae32ea29b2814d6e54b
    - if:
      - condition: state
        entity_id: switch.disjoncteur_4_none
        state: 'off'
      - condition: state
        entity_id: input_boolean.mode_chauffage
        state: 'on'
      then:
      - action: switch.turn_on
        metadata: {}
        data: {}
        target:
          device_id:
          - 95cac785555a1625a4b133475bc2c04b
      enabled: true
    - if:
      - condition: state
        entity_id: switch.prise_tv_local
        state: 'off'
      then:
      - action: switch.turn_on
        metadata: {}
        data: {}
        target:
          device_id:
          - ccfd320c2ae171b9cbca0e8d97e04e9d
    - if:
      - condition: state
        entity_id: switch.prise_lave_linge_local
        state: 'off'
      then:
      - action: switch.turn_on
        metadata: {}
        data: {}
        target:
          device_id:
          - f6b1ca126ebf449238fb940da0aa0c2f
    - if:
      - condition: state
        entity_id: switch.prise_lave_vaisselle_local
        state: 'off'
      then:
      - action: switch.turn_on
        metadata: {}
        data: {}
        target:
          device_id:
          - d4d1a674deef9c59116468790efc2b84
  mode: single
- id: '1732522539929'
  alias: Désactivation Prises connectées
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - schedule.calendrier_chauffage_salon
    from: 'on'
    to: 'off'
  conditions:
  - condition: state
    entity_id: input_boolean.automatisation
    state: 'on'
  - condition: state
    entity_id: input_boolean.mode_present_a_la_maison
    state: 'off'
  actions:
  - parallel:
    - if:
      - condition: state
        entity_id: switch.disjoncteur_3_local
        state: 'on'
      - condition: numeric_state
        entity_id: sensor.disjoncteur_3_puissance_2
        below: 50
      - condition: state
        entity_id: input_boolean.mode_chauffage
        state: 'off'
      then:
      - action: switch.turn_off
        metadata: {}
        data: {}
        target:
          device_id:
          - 2e6fb60152117ae32ea29b2814d6e54b
      enabled: true
    - if:
      - condition: state
        entity_id: switch.disjoncteur_4_none
        state: 'on'
      - condition: numeric_state
        entity_id: sensor.disjoncteur_4_puissance_2
        below: 50
      - condition: state
        entity_id: input_boolean.mode_chauffage
        state: 'off'
      then:
      - action: switch.turn_off
        metadata: {}
        data: {}
        target:
          device_id:
          - 95cac785555a1625a4b133475bc2c04b
      enabled: true
    - if:
      - condition: state
        entity_id: switch.prise_tv_local
        state: 'on'
      - condition: numeric_state
        entity_id: sensor.prise_tv_puissance
        below: 20
      then:
      - action: switch.turn_off
        metadata: {}
        data: {}
        target:
          device_id:
          - ccfd320c2ae171b9cbca0e8d97e04e9d
    - if:
      - condition: state
        entity_id: switch.prise_lave_linge_local
        state: 'on'
      - condition: numeric_state
        entity_id: sensor.prise_lave_linge_local_puissance
        below: 5
      then:
      - action: switch.turn_off
        metadata: {}
        data: {}
        target:
          device_id:
          - f6b1ca126ebf449238fb940da0aa0c2f
    - if:
      - condition: state
        entity_id: switch.prise_lave_vaisselle_local
        state: 'on'
      - condition: numeric_state
        entity_id: sensor.prise_lave_vaiselle_local_puissance
        below: 5
      then:
      - action: switch.turn_off
        metadata: {}
        data: {}
        target:
          device_id:
          - d4d1a674deef9c59116468790efc2b84
  mode: single
- id: '1732524915144'
  alias: Tuya Zigbee 4 button remote
  description: ''
  use_blueprint:
    path: Soulfly999/Tuya_TS0044_1_remote.yaml
    input:
      switch: sensor.telecommande_zigbee_action
      button_1_hold:
      - type: turn_off
        device_id: 2e6fb60152117ae32ea29b2814d6e54b
        entity_id: 3c829a1b3bf8daa103734b4919d21c4a
        domain: switch
      button_2_short_press:
      - action: climate.toggle
        metadata: {}
        data: {}
        target:
          device_id: d2910ca682aff1ab63ccc59776862bbf
      button_2_hold:
      - type: toggle
        device_id: 2e6fb60152117ae32ea29b2814d6e54b
        entity_id: 3c829a1b3bf8daa103734b4919d21c4a
        domain: switch
      button_1_short_press:
      - action: climate.toggle
        metadata: {}
        data: {}
        target:
          device_id: ca5a1d4d5c652e5a540deaaae09f9405
      button_3_double_press: []
      button_4_hold:
      - type: toggle
        device_id: 95cac785555a1625a4b133475bc2c04b
        entity_id: 14ca4b5b3f71761abd8c5ea4e738f8da
        domain: switch
      button_3_hold:
      - type: toggle
        device_id: 2e6fb60152117ae32ea29b2814d6e54b
        entity_id: 3c829a1b3bf8daa103734b4919d21c4a
        domain: switch
      button_1_double_press: []
      button_3_short_press:
      - action: climate.toggle
        metadata: {}
        data: {}
        target:
          device_id: 280904bd43829cf2b64d322cd3b67cd1
- id: shellies_announce_gen2
  alias: Shellies Announce Gen2
  triggers:
  - event: start
    trigger: homeassistant
  actions:
  - repeat:
      for_each: '{{ device_ids }}'
      sequence:
      - action: mqtt.publish
        data:
          topic: '{{ repeat.item }}/rpc'
          payload: '{{ get_config_payload }}'
      - action: mqtt.publish
        data:
          topic: '{{ repeat.item }}/rpc'
          payload: '{{ get_config_payload }}'
  variables:
    get_config_payload: '{{ {''id'': 1, ''src'': ''shellies_discovery'', ''method'':
      ''Shelly.GetConfig''} | to_json }}'
    get_components_payload: '{{ {''id'': 1, ''src'': ''shellies_discovery'', ''method'':''Shelly.GetComponents'',
      ''params'': {''include'': [''config'']}} | to_json }}'
    device_ids:
    - shellyproem50-08f9e0e69644
    - shellyplus1pm-08b61f6b65e0
    - shellyplus1pm-b0b21c0e9048
- id: shellies_discovery_gen2
  alias: Shellies Discovery Gen2
  triggers:
  - topic: shellies_discovery/rpc
    trigger: mqtt
  actions:
  - action: python_script.shellies_discovery_gen2
    data:
      id: '{{ trigger.payload_json.src }}'
      device_config: '{{ trigger.payload_json.result }}'
  - condition: template
    value_template: '{{ ''mqtt'' in trigger.payload_json.result }}'
  - data:
      topic: '{{ trigger.payload_json.result.mqtt.topic_prefix }}/command'
      payload: status_update
    action: mqtt.publish
  mode: queued
  max: 999
- id: shelly_mqtt_event_stream
  alias: Shelly BLE Event Stream
  triggers:
  - topic: shellyblugw-fcb4670003e0/events/rpc
    trigger: mqtt
  actions:
  - repeat:
      for_each: '{{ events }}'
      sequence:
      - variables:
          mac: '{{ repeat.item.mac }}'
          unique_id: '{{ mac | slugify }}'
          rssi: '{{ repeat.item.rssi }}'
          ts: '{{ repeat.item.ts }}'
          topic: '{{ root }}/sensor/{{ unique_id }}'
          state_topic: '{{ topic }}/state'
      - alias: MQTT Discovery
        data:
          topic: '{{ topic }}/config'
          payload: "{{\n  {\n    'name': unique_id,\n    'unique_id': unique_id,\n
            \   'state_topic': state_topic,\n    'value_template': rssi,\n    'unit_of_measurement':
            'dBm',\n    'device_class': 'signal_strength',\n    'json_attributes_topic':
            state_topic,\n  } | to_json\n}}\n"
          retain: true
        action: mqtt.publish
      - alias: MQTT State Update
        data:
          topic: '{{ state_topic }}'
          payload: "{{\n  {\n    'state': rssi,\n    'attributes': {\n      'ts':
            ts,\n      'mac': mac\n    } | to_json\n  } | to_json\n}}\n"
          retain: true
        action: mqtt.publish
  variables:
    root: homeassistant
    domain: sensor
    payload: '{{ trigger.payload_json }}'
    events: "{% set payload = trigger.payload_json | default({}) %} {% if payload
      and payload.params and payload.params.events %}\n  {% set ns = namespace(items=[])
      %}\n  {% for event in payload.params.events %}\n    {% if event.data and event.data[1]
      %}\n      {% for device in event.data[1] %}\n        {% set mac = device[0]
      %}\n        {% set rssi = device[1] %}\n        {% set ts = event.ts %}\n        {%
      set ns.items = ns.items + [ dict(mac=mac, rssi=rssi, ts=ts) ] %}\n      {% endfor
      %}\n    {% endif %}\n  {% endfor %}\n  {{ ns.items | to_json }}\n{% else %}\n
      \ []\n{% endif %}\n"
  mode: parallel
- id: '1734880030099'
  alias: MAJ SQL
  description: ''
  triggers:
  - trigger: time_pattern
    minutes: '2'
  conditions: []
  actions:
  - action: homeassistant.reload_config_entry
    metadata: {}
    data: {}
    target:
      entity_id:
      - sensor.database
      - sensor.top_values
      - sensor.maj_linky
  - action: shell_command.maj_surplus_eco
    data: {}
  - action: shell_command.maj_hp_hc
    data: {}
  mode: single
- id: '1735138356842'
  alias: Mode Alarme
  description: ''
  triggers:
  - trigger: homeassistant
    event: start
  - trigger: state
    entity_id:
    - input_boolean.mode_alarme
    to: 'on'
  conditions:
  - condition: state
    entity_id: input_boolean.mode_alarme
    state: 'on'
  actions:
  - device_id: aab5f37f0a93de31749a7333b931244f
    domain: alarm_control_panel
    entity_id: 239b258830c43f2639f97bd411235b17
    type: arm_away
  - device_id: 1322209f97873efa2a5eac11cbf5990b
    domain: alarm_control_panel
    entity_id: f89926d6fd73142433881df57c7347aa
    type: arm_away
  - repeat:
      sequence:
      - wait_for_trigger:
        - trigger: state
          entity_id:
          - binary_sensor.detection_mouvement
          to: 'on'
      - action: notify.notify
        metadata: {}
        data:
          title: Détection de mouvement
          message: Détection de mouvement sur les caméras !
      while:
      - condition: and
        conditions:
        - condition: or
          conditions:
          - condition: device
            device_id: aab5f37f0a93de31749a7333b931244f
            domain: alarm_control_panel
            entity_id: 239b258830c43f2639f97bd411235b17
            type: is_armed_home
          - condition: device
            device_id: 1322209f97873efa2a5eac11cbf5990b
            domain: alarm_control_panel
            entity_id: f89926d6fd73142433881df57c7347aa
            type: is_armed_away
        - condition: state
          entity_id: input_boolean.mode_alarme
          state: 'on'
  mode: single
- id: '1735164173198'
  alias: MAJ Données énergie
  description: ''
  triggers:
  - entity_id:
    - sensor.maj_linky
    enabled: false
    trigger: state
  - value_template: '{{ states(''sensor.maj_linky'') != states(''input_datetime.maj_linky'')
      and states(''sensor.maj_linky'')!=''unavailable'' }}'
    trigger: template
    id: maj_linky
  - value_template: "{% set maj = states('sensor.maj_linky') %}\n{% if maj in ['unknown',
      'unavailable'] %}\n  false\n{% else %}\n  {% set maj_dt = strptime(maj, '%Y-%m-%d
      %H:%M:%S').replace(tzinfo=now().tzinfo) %}\n  {{ now() > maj_dt + timedelta(hours=36)
      }}\n{% endif %}"
    trigger: template
    id: retard
  conditions:
  - condition: not
    conditions:
    - condition: state
      entity_id: sensor.maj_linky
      state: unavailable
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - maj_linky
      sequence:
      - if: []
        then:
        - response_variable: retour
          action: shell_command.maj_linky
          data: {}
        - target:
            entity_id: input_datetime.maj_linky
          data:
            datetime: '{{ states(''sensor.maj_linky'') }}'
          action: input_datetime.set_datetime
        - delay:
            seconds: 5
        - action: shell_command.maj_surplus
          data: {}
        - delay:
            seconds: 5
        - action: shell_command.maj_conso
          data: {}
        - delay:
            seconds: 5
        - action: shell_command.maj_conso_non_suivie
          data: {}
    - conditions:
      - condition: trigger
        id:
        - retard
      sequence:
      - data:
          message: MAJ données LINKY NOK
        action: notify.notify
  mode: single
- id: '1736458938405'
  alias: Fermer Volets
  description: ''
  triggers: []
  conditions: []
  actions:
  - action: cover.close_cover
    metadata: {}
    data: {}
    target:
      entity_id:
      - cover.volets
      - cover.fenetres
      - cover.stores
  mode: single
- id: '1736622557524'
  alias: Mode forcé ECS
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - switch.shelly_plus_1pm_01_switch_0
    to: 'on'
  conditions:
  - condition: state
    state: 'off'
    entity_id: switch.cumulus
  actions:
  - type: turn_on
    device_id: 62be3297a0c0d75c708f1a2e49911819
    entity_id: 84ede9c070c6abc84dbd5367e484c988
    domain: switch
  mode: single
- id: '1737406944308'
  alias: Impression
  description: ''
  triggers:
  - trigger: numeric_state
    entity_id:
    - sensor.prise_zigbee_2_power
    above: 10
  conditions: []
  actions:
  - action: input_number.set_value
    metadata: {}
    data_template:
      value: '{{float(states(''sensor.prise_zigbee_2_energy''),0) | round(0)}}'
    target:
      entity_id: input_number.bambulab_energie
  - wait_for_trigger:
    - trigger: numeric_state
      entity_id:
      - sensor.prise_zigbee_2_power
      below: 29.9
  - action: notify.notify
    metadata: {}
    data_template:
      title: 'Impression terminée{% if states(''sensor.a1mini_0309da4b0803686_nom_de_la_tache'')==''unavailable''
        %} ! {% else %} de {{states(''sensor.a1mini_0309da4b0803686_nom_de_la_tache'')}}
        !{% endif %}

        '
      message: '{% set duree=as_timestamp(now())-as_timestamp(state_attr(''automation.impression'',''last_triggered''))%}

        {% set filament=(30)*(duree-600)/3600%}

        Consommation : {{((float(states(''sensor.prise_zigbee_2_energy''),0) - float(states(''input_number.bambulab_energie''),0))
        * 1000) | round(0)}} Wh.

        Durée : {{(duree//3660%60)| round(0)}}:{{(duree//60%60)| round(0) }}

        Estimation de filament : {{ filament | round(0) }} / {{(float(states(''input_number.filament_restant''),0)-filament)
        | round(0)}} g.

        '
  - action: input_number.set_value
    metadata: {}
    data_template:
      value: '{% set duree=as_timestamp(now())-as_timestamp(state_attr(''automation.impression'',''last_triggered''))%}

        {% set filament=(30)*(duree-600)/3600%}

        {% set filament_restant=(float(states(''input_number.filament_restant''),0)-filament)
        | round(0)%}

        {{filament_restant}}

        '
    target:
      entity_id: input_number.filament_restant
  mode: single
- id: '1738445050889'
  alias: Activation Poêle
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - schedule.calendrier_chauffage_poele
    from: 'off'
    to: 'on'
  conditions:
  - condition: state
    entity_id: input_boolean.automatisation
    state: 'on'
  - condition: state
    entity_id: input_boolean.mode_chauffage
    state: 'on'
  - condition: numeric_state
    entity_id: sensor.poele_talence_air_temperature
    below: 17.6
  - condition: device
    device_id: 4bead898b9b54fc49d86653276a54edb
    domain: climate
    entity_id: 35deb8dae9d42e1a1b7d379c4db33296
    type: is_hvac_mode
    hvac_mode: 'off'
  actions:
  - if:
    - condition: numeric_state
      entity_id: sensor.poele_talence_air_temperature
      above: 15.9
    then:
    - delay:
        hours: 0
        minutes: 30
        seconds: 0
        milliseconds: 0
  - if:
    - condition: numeric_state
      entity_id: sensor.poele_talence_air_temperature
      above: 15.4
    then:
    - delay:
        hours: 0
        minutes: 30
        seconds: 0
        milliseconds: 0
  - action: climate.set_hvac_mode
    metadata: {}
    data:
      hvac_mode: heat
    target:
      entity_id: climate.poele_talence
  - device_id: 4bead898b9b54fc49d86653276a54edb
    domain: number
    entity_id: 70d168bdfe6cbd5030911309cb78b3e9
    type: set_value
    value: 3
  - action: climate.set_temperature
    metadata: {}
    data:
      temperature: 19
    target:
      entity_id: climate.poele_talence
  - action: climate.set_fan_mode
    metadata: {}
    data:
      fan_mode: '2'
    target:
      entity_id: climate.poele_talence_canalisation_1
  mode: single
- id: '1738445840591'
  alias: Désactivation poêle
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - schedule.calendrier_chauffage_poele
    from: 'on'
    to: 'off'
  conditions:
  - condition: state
    entity_id: input_boolean.automatisation
    state: 'on'
  - condition: not
    conditions:
    - condition: state
      entity_id: sensor.poele_talence_status
      state: STAND-BY
  - condition: state
    entity_id: input_boolean.mode_absent
    state: 'off'
  actions:
  - device_id: 4bead898b9b54fc49d86653276a54edb
    domain: climate
    entity_id: 35deb8dae9d42e1a1b7d379c4db33296
    type: set_hvac_mode
    hvac_mode: 'off'
  mode: single
- id: '1738535515762'
  alias: Alarme Poêle
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - sensor.poele_talence_status
    to: ALARM MEM.
  conditions: []
  actions:
  - action: notify.notify
    metadata: {}
    data:
      message: Plus de pellets dans le poêle !
      title: Poêle
  mode: single
- id: '1738573964721'
  alias: Alerte Monoxyde
  description: ''
  triggers:
  - trigger: numeric_state
    entity_id:
    - sensor.detecteur_co_fumee_monoxyde_de_carbone
    above: 0
  - trigger: state
    entity_id:
    - binary_sensor.detecteur_co_fumee_alarm_status
    to: 'on'
  conditions: []
  actions:
  - action: notify.mobile_app_iphone_de_mat_13
    metadata: {}
    data:
      message: Alerte présence de Monoxyde de carbone !!
      title: Alerte
      data:
        push:
          interruption-level: critical
  mode: single
- id: '1739055175332'
  alias: Allumages poêle
  description: ''
  triggers:
  - trigger: numeric_state
    entity_id:
    - sensor.prise_zigbee_3_power
    above: 450
  conditions: []
  actions:
  - action: counter.increment
    metadata: {}
    data: {}
    target:
      entity_id: counter.allumages_poele
  mode: single
- id: '1742158035852'
  alias: Alerte ESP32-2
  description: ''
  triggers:
  - entity_id:
    - sensor.esphome_web_27f580_ultrasonic_sensor
    for:
      hours: 0
      minutes: 30
      seconds: 0
    trigger: state
  - entity_id:
    - sensor.esphome_web_27f580_ultrasonic_sensor
    for:
      hours: 0
      minutes: 5
      seconds: 0
    trigger: state
    to: unavailable
  conditions:
  - condition: device
    type: is_on
    device_id: 6eecb13b5db3dfd40f6cec2e96ad8b4c
    entity_id: fa0a8d492257c10ad67851e12806f64d
    domain: switch
  actions:
  - data:
      message: Pas de réponse de ESP32-2 !
    action: notify.persistent_notification
  - action: notify.notify
    metadata: {}
    data:
      message: Pas de réponse de ESP32-2 !
  - delay:
      hours: 0
      minutes: 5
      seconds: 0
      milliseconds: 0
  mode: single
- id: '1743596448001'
  alias: Désactiver batterie
  description: ''
  triggers: []
  conditions: []
  actions:
  - device_id: cad5cf1c1acf9585f1a244da05cf1cac
    domain: select
    entity_id: 6e525dc6e7cf73abc626c817e8002ce6
    type: select_option
    option: enable
  - device_id: cad5cf1c1acf9585f1a244da05cf1cac
    domain: select
    entity_id: 29d02385bfa6a107834f0b8cab20c349
    type: select_option
    option: manual
  - device_id: cad5cf1c1acf9585f1a244da05cf1cac
    domain: select
    entity_id: d9f81c55028cbfb4283f09a46b1cf024
    type: select_option
    option: stop
  - delay:
      hours: 0
      minutes: 0
      seconds: 1
      milliseconds: 0
  - device_id: cad5cf1c1acf9585f1a244da05cf1cac
    domain: select
    entity_id: 6e525dc6e7cf73abc626c817e8002ce6
    type: select_option
    option: disable
  mode: single
- id: '1743596690192'
  alias: Activer batterie
  description: ''
  triggers: []
  conditions: []
  actions:
  - device_id: cad5cf1c1acf9585f1a244da05cf1cac
    domain: select
    entity_id: 6e525dc6e7cf73abc626c817e8002ce6
    type: select_option
    option: enable
  - device_id: cad5cf1c1acf9585f1a244da05cf1cac
    domain: select
    entity_id: 29d02385bfa6a107834f0b8cab20c349
    type: select_option
    option: anti-feed
  - delay:
      hours: 0
      minutes: 0
      seconds: 1
      milliseconds: 0
  - device_id: cad5cf1c1acf9585f1a244da05cf1cac
    domain: select
    entity_id: 6e525dc6e7cf73abc626c817e8002ce6
    type: select_option
    option: disable
  - type: turn_off
    device_id: 62be3297a0c0d75c708f1a2e49911819
    entity_id: 84ede9c070c6abc84dbd5367e484c988
    domain: switch
  mode: single
- id: '1744146911051'
  alias: Relance batterie
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - select.esphome_web_a92940_marstek_user_work_mode
    from: anti-feed
    to: manual
  conditions:
  - condition: state
    entity_id: select.esphome_web_a92940_marstek_rs485_control_mode
    state: disable
  - condition: numeric_state
    entity_id: sensor.esphome_web_a92940_marstek_battery_state_of_charge
    above: number.esphome_web_a92940_marstek_discharging_cutoff_capacity
  actions:
  - action: notify.notify
    metadata: {}
    data:
      message: Batterie arrêtée
  - if:
    - condition: trigger
      id:
      - Saturation
    then:
    - delay:
        hours: 0
        minutes: 0
        seconds: 20
        milliseconds: 0
    - if:
      - condition: numeric_state
        entity_id: sensor.em06_02_b1_power
        above: 2000
      - condition: numeric_state
        entity_id: sensor.cumulus_2
        below: 5
      then:
      - wait_for_trigger:
        - trigger: numeric_state
          entity_id:
          - sensor.em06_02_b1_power
          for:
            hours: 0
            minutes: 1
            seconds: 30
          below: 2000
      - action: automation.trigger
        metadata: {}
        data:
          skip_condition: true
        target:
          entity_id: automation.activer_batterie
      - action: notify.notify
        metadata: {}
        data:
          message: Batterie relancée
  - type: turn_off
    device_id: 62be3297a0c0d75c708f1a2e49911819
    entity_id: 84ede9c070c6abc84dbd5367e484c988
    domain: switch
  mode: single
- id: '1744634272723'
  alias: Gestion priorité
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - input_boolean.priorite_batterie
    from: 'off'
    to: 'on'
    id: batterie
  - trigger: state
    entity_id:
    - input_boolean.priorite_batterie
    from: 'on'
    to: 'off'
    id: ecs
  conditions:
  - condition: state
    entity_id: input_boolean.automatisation
    state: 'on'
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - batterie
      sequence:
      - action: input_boolean.turn_off
        metadata: {}
        data: {}
        target:
          entity_id: input_boolean.charge_batterie_pilotee
      - action: automation.trigger
        metadata: {}
        data:
          skip_condition: true
        target:
          entity_id: automation.activer_batterie
      - type: turn_off
        device_id: 62be3297a0c0d75c708f1a2e49911819
        entity_id: 84ede9c070c6abc84dbd5367e484c988
        domain: switch
      - action: automation.turn_off
        metadata: {}
        data:
          stop_actions: true
        target:
          entity_id: automation.activation_routeur_solaire
    - conditions:
      - condition: trigger
        id:
        - ecs
      sequence:
      - action: automation.trigger
        metadata: {}
        data:
          skip_condition: true
        target:
          entity_id: automation.desactiver_batterie
      - action: automation.turn_off
        metadata: {}
        data:
          stop_actions: true
        target:
          entity_id: automation.relance_batterie
      - action: automation.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: automation.activation_routeur_solaire
        enabled: true
      - type: turn_on
        device_id: 62be3297a0c0d75c708f1a2e49911819
        entity_id: 84ede9c070c6abc84dbd5367e484c988
        domain: switch
  mode: restart
- id: '1744753049397'
  alias: Alerte batterie & chauffe-eau
  description: Lorsque la batterie se décharge et le chauffe-eau est en charge, envoie
    une notification avec bouton pour désactiver la priorité batterie.
  triggers:
  - value_template: '{{ (states(''sensor.consommation_batterie'')|float(0) > 50) and
      (states(''sensor.consommation_cumulus'')|float(0) > 50) }}

      '
    for:
      hours: 0
      minutes: 1
      seconds: 0
    trigger: template
    id: alerte
  conditions: []
  actions:
  - if:
    - condition: trigger
      id:
      - alerte
    then:
    - data:
        message: La batterie se décharge et le chauffe-eau est en charge. Désactivation
          du Cumulus.
      action: notify.mobile_app_iphone_de_mat_13
    - target:
        entity_id:
        - input_boolean.priorite_batterie
        - input_boolean.gestion_batterie_autonome
      action: input_boolean.turn_off
      data: {}
      enabled: false
    - action: automation.trigger
      metadata: {}
      data:
        skip_condition: true
      target:
        entity_id: automation.desactiver_batterie
      enabled: false
    - wait_for_trigger:
      - value_template: '{{ (states(''sensor.consommation_cumulus'')|float(0) < 10)
          }}

          '
        for:
          hours: 0
          minutes: 1
          seconds: 0
        trigger: template
        id: alerte
      enabled: false
    - action: input_boolean.turn_on
      target:
        entity_id:
        - input_boolean.priorite_batterie
        - input_boolean.gestion_batterie_autonome
      data: {}
      enabled: false
  - type: turn_off
    device_id: 62be3297a0c0d75c708f1a2e49911819
    entity_id: 84ede9c070c6abc84dbd5367e484c988
    domain: switch
  mode: single
- id: '1744807044766'
  alias: Alerte Marstek
  description: ''
  triggers:
  - entity_id:
    - binary_sensor.capteurs_marstek
    from: 'off'
    to:
    trigger: state
  conditions: []
  actions:
  - data:
      message: "Alerte Marstek : {{\n  state_attr(trigger.get('entity_id',''), 'friendly_name')
        or 'Capteur inconnu'\n}} est en défaut."
    action: notify.notify
  mode: single
- id: '1744807759043'
  alias: Gestion batterie autonome
  description: Pilotage direct batterie avec compensation et gestion SOC
  triggers:
  - entity_id: sensor.em06_02_b1_power
    id: mise_a_jour_reseau
    trigger: state
  - entity_id: input_boolean.gestion_batterie_autonome
    to: 'on'
    id: activation_gestion
    trigger: state
  - entity_id: input_boolean.gestion_batterie_autonome
    to: 'off'
    id: desactivation_gestion
    trigger: state
  conditions: []
  actions:
  - variables:
      puissance_reseau: '{{ states(''sensor.em06_02_b1_power'') | float(0) }}'
      puissance_batterie: '{{ states(''sensor.em06_02_b2_power'') | float(0) }}'
      consigne_batterie: '{{ puissance_reseau + puissance_batterie }}'
      puissance_charge_max: '{{ states(''number.esphome_web_a92940_marstek_max_charge_power'')
        | float(0) }}'
      puissance_decharge_max: '{{ states(''number.esphome_web_a92940_marstek_max_discharge_power'')
        | float(0) }}'
      soc_batterie: '{{ states(''sensor.esphome_web_a92940_marstek_battery_state_of_charge'')
        | float(0) }}'
      soc_max: '{{ states(''number.esphome_web_a92940_marstek_charging_cutoff_capacity'')
        | float(0) }}'
      soc_min: '{{ states(''number.esphome_web_a92940_marstek_discharging_cutoff_capacity'')
        | float(0) }}'
      voltage: '{{ states(''sensor.esphome_web_a92940_marstek_battery_voltage_average'')
        | float(0) }}'
      correction_consigne_decharge: 0
      correction_consigne_charge: 0
    alias: Calcul des variables
  - alias: Choix entre désactivation et charge/décharge
    choose:
    - conditions:
      - alias: SOC MIN/MAX ou désactivation
        condition: or
        conditions:
        - condition: trigger
          id:
          - redemarrage_ha
          - desactivation_gestion
      sequence:
      - alias: Mode Stop
        if:
        - condition: not
          conditions:
          - condition: state
            entity_id: select.esphome_web_a92940_marstek_forcible_charge_discharge
            state: stop
        then:
        - target:
            entity_id: select.esphome_web_a92940_marstek_forcible_charge_discharge
          data:
            option: stop
          action: select.select_option
      - target:
          entity_id:
          - number.esphome_web_a92940_marstek_forcible_charge_power
          - number.esphome_web_a92940_marstek_forcible_discharge_power
        data:
          value: '0'
        action: number.set_value
        alias: Charge/Discharge à 0
      - alias: Mode Disable
        if:
        - condition: not
          conditions:
          - condition: state
            entity_id: select.esphome_web_a92940_marstek_rs485_control_mode
            state: disable
          alias: Mode Disable
        then:
        - target:
            entity_id: select.esphome_web_a92940_marstek_rs485_control_mode
          data:
            option: disable
          action: select.select_option
          alias: Mode Disable
      alias: Désactivation
    - conditions:
      - condition: state
        entity_id: input_boolean.gestion_batterie_autonome
        state: 'on'
      sequence:
      - choose:
        - conditions:
          - condition: template
            value_template: '{{ consigne_batterie >= -10 and consigne_batterie <=
              10 }}'
            alias: Zone morte (+/- 10W)
          sequence:
          - alias: Charge à 0
            target:
              entity_id:
              - number.esphome_web_a92940_marstek_forcible_charge_power
              - number.esphome_web_a92940_marstek_forcible_discharge_power
            data:
              value: '0'
            action: number.set_value
            enabled: false
          - alias: Mode Stop
            if:
            - condition: not
              conditions:
              - condition: state
                entity_id: select.esphome_web_a92940_marstek_forcible_charge_discharge
                state: stop
            then:
            - target:
                entity_id: select.esphome_web_a92940_marstek_forcible_charge_discharge
              data:
                option: stop
              action: select.select_option
            enabled: false
          - if:
            - condition: state
              entity_id: select.esphome_web_a92940_marstek_rs485_control_mode
              state: disable
            then:
            - target:
                entity_id: select.esphome_web_a92940_marstek_rs485_control_mode
              data:
                option: enable
              action: select.select_option
            alias: Mode Enable
            enabled: false
          alias: Zone morte (+/- 10W)
        - conditions:
          - condition: template
            value_template: '{{ consigne_batterie > 10 }}'
            alias: Discharge > 10W
          sequence:
          - alias: Comparaison SOC MIN
            choose:
            - conditions:
              - alias: SOC = MIN
                condition: template
                value_template: '{{ soc_batterie <= soc_min}}'
                enabled: true
              sequence:
              - alias: Mode Stop
                if:
                - condition: not
                  conditions:
                  - condition: state
                    entity_id: select.esphome_web_a92940_marstek_forcible_charge_discharge
                    state: stop
                then:
                - target:
                    entity_id: select.esphome_web_a92940_marstek_forcible_charge_discharge
                  data:
                    option: stop
                  action: select.select_option
              - target:
                  entity_id:
                  - number.esphome_web_a92940_marstek_forcible_charge_power
                  - number.esphome_web_a92940_marstek_forcible_discharge_power
                data:
                  value: '0'
                action: number.set_value
                alias: Charge/Discharge à 0
              - if:
                - condition: state
                  entity_id: select.esphome_web_a92940_marstek_rs485_control_mode
                  state: disable
                then:
                - target:
                    entity_id: select.esphome_web_a92940_marstek_rs485_control_mode
                  data:
                    option: enable
                  action: select.select_option
                alias: Mode Enable
            - conditions:
              - alias: SOC > MIN
                condition: template
                value_template: '{{ soc_batterie >= soc_min}}'
                enabled: true
              sequence:
              - if:
                - condition: not
                  conditions:
                  - condition: state
                    entity_id: select.esphome_web_a92940_marstek_forcible_charge_discharge
                    state: discharge
                  alias: Mode Discharge
                then:
                - target:
                    entity_id: select.esphome_web_a92940_marstek_forcible_charge_discharge
                  data:
                    option: discharge
                  action: select.select_option
                  alias: Mode Discharge
                alias: Mode Discharge
              - alias: Charge à 0
                target:
                  entity_id:
                  - number.esphome_web_a92940_marstek_forcible_charge_power
                data:
                  value: '0'
                action: number.set_value
              - target:
                  entity_id: number.esphome_web_a92940_marstek_forcible_discharge_power
                data:
                  value: "{% if voltage <= 48.0 %}\n  {% set puissance_decharge_max
                    = 500 %}\n{% endif %} {% set besoin = consigne_batterie + correction_consigne_decharge
                    %} {% if besoin > puissance_decharge_max %}\n  {{ puissance_decharge_max
                    | int }}\n{% else %}\n  {{ [besoin, 0] | max | int }}\n{% endif
                    %}\n"
                action: number.set_value
                alias: Valeur de Discharge
              - if:
                - condition: state
                  entity_id: select.esphome_web_a92940_marstek_rs485_control_mode
                  state: disable
                then:
                - target:
                    entity_id: select.esphome_web_a92940_marstek_rs485_control_mode
                  data:
                    option: enable
                  action: select.select_option
                alias: Mode Enable
          alias: Décharge
        - conditions:
          - condition: template
            value_template: '{{ consigne_batterie < -10 }}'
            alias: Charge < -10W
          sequence:
          - alias: Comparaison SOC MAX
            choose:
            - conditions:
              - alias: SOC = MAX
                condition: template
                value_template: '{{ soc_batterie >= soc_max}}'
                enabled: true
              sequence:
              - alias: Mode Stop
                if:
                - condition: not
                  conditions:
                  - condition: state
                    entity_id: select.esphome_web_a92940_marstek_forcible_charge_discharge
                    state: stop
                then:
                - target:
                    entity_id: select.esphome_web_a92940_marstek_forcible_charge_discharge
                  data:
                    option: stop
                  action: select.select_option
              - target:
                  entity_id:
                  - number.esphome_web_a92940_marstek_forcible_charge_power
                  - number.esphome_web_a92940_marstek_forcible_discharge_power
                data:
                  value: '0'
                action: number.set_value
                alias: Charge/Discharge à 0
              - alias: Mode Disable
                if:
                - condition: state
                  entity_id: select.esphome_web_a92940_marstek_rs485_control_mode
                  state: enable
                then:
                - target:
                    entity_id: select.esphome_web_a92940_marstek_rs485_control_mode
                  data:
                    option: disable
                  action: select.select_option
              - device_id: cad5cf1c1acf9585f1a244da05cf1cac
                domain: select
                entity_id: 29d02385bfa6a107834f0b8cab20c349
                type: select_option
                option: anti-feed
            - conditions:
              - alias: SOC < MAX
                condition: template
                value_template: '{{ soc_batterie < soc_max}}'
                enabled: true
              sequence:
              - alias: Mode charge
                if:
                - condition: not
                  conditions:
                  - condition: state
                    entity_id: select.esphome_web_a92940_marstek_forcible_charge_discharge
                    state: charge
                  alias: Mode Charge
                then:
                - target:
                    entity_id: select.esphome_web_a92940_marstek_forcible_charge_discharge
                  data:
                    option: charge
                  action: select.select_option
              - target:
                  entity_id: number.esphome_web_a92940_marstek_forcible_discharge_power
                data:
                  value: '0'
                action: number.set_value
                alias: Discharge à 0
              - alias: Valeur de charge
                target:
                  entity_id: number.esphome_web_a92940_marstek_forcible_charge_power
                data:
                  value: "{% if voltage >= 54.5 %}\n  {% set puissance_charge_max
                    = 100 %}\n{% elif voltage >= 54 %}\n  {% set puissance_charge_max
                    = 500 %}\n{% endif %} {% set dispo = (consigne_batterie | abs)
                    + correction_consigne_charge %} {% if dispo > puissance_charge_max
                    %}\n  {{ puissance_charge_max | int }}\n{% else %}\n  {{ [dispo,
                    0] | max | int }}\n{% endif %}\n"
                action: number.set_value
              - if:
                - condition: state
                  entity_id: select.esphome_web_a92940_marstek_rs485_control_mode
                  state: disable
                then:
                - target:
                    entity_id: select.esphome_web_a92940_marstek_rs485_control_mode
                  data:
                    option: enable
                  action: select.select_option
                alias: Mode Enable
          alias: Charge
      alias: Charge/Décharge
  mode: single
- id: '1744819508007'
  alias: Batterie pleine
  description: ''
  triggers:
  - value_template: "{{ states('sensor.esphome_web_a92940_marstek_battery_state_of_charge')
      | float(0) ==\n   states('number.esphome_web_a92940_marstek_charging_cutoff_capacity')
      | float(0) and is_state('input_boolean.batterie_notification_envoyee','off')
      and states('sensor.esphome_web_a92940_marstek_battery_state_of_charge') != 'unavailable'
      and states('sensor.esphome_web_a92940_marstek_battery_state_of_charge') != 'unknown'}}\n"
    trigger: template
  conditions: []
  actions:
  - target:
      entity_id: input_boolean.batterie_notification_envoyee
    action: input_boolean.turn_on
    data: {}
  - data:
      message: "\U0001F50B Batterie pleine ({{ states('sensor.esphome_web_a92940_marstek_battery_state_of_charge')
        }}%)"
      data:
        actions:
        - action: desactiver_batterie
          title: "\U0001F50C Couper la batterie"
        - action: desactiver_priorite
          title: ❌ Désactiver priorité batterie
    action: notify.notify
  - wait_for_trigger:
    - event_type: mobile_app_notification_action
      event_data:
        action: desactiver_batterie
      trigger: event
    - event_type: mobile_app_notification_action
      event_data:
        action: desactiver_priorite
      trigger: event
    timeout: 00:10:00
    continue_on_timeout: true
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ wait.trigger.event.data.action == ''desactiver_batterie''
          }}'
      sequence:
      - data:
          skip_condition: true
        target:
          entity_id: automation.desactiver_batterie
        action: automation.trigger
    - conditions:
      - condition: template
        value_template: '{{ wait.trigger.event.data.action == ''desactiver_priorite''
          }}'
      sequence:
      - condition: state
        entity_id: input_boolean.priorite_batterie
        state: 'on'
      - target:
          entity_id: input_boolean.priorite_batterie
        action: input_boolean.turn_off
        data: {}
  mode: single
- id: '1744820100625'
  alias: Reset notif batterie pleine
  description: Réinitialise la notification quand la batterie est sous 90% du seuil
    de coupure
  triggers:
  - value_template: '{% set cutoff = states(''number.esphome_web_a92940_marstek_charging_cutoff_capacity'')
      | float(100) %} {% set soc = states(''sensor.esphome_web_a92940_marstek_battery_state_of_charge'')
      | float(0) %} {{ soc < (cutoff * 0.9) }}

      '
    trigger: template
  conditions: []
  actions:
  - target:
      entity_id: input_boolean.batterie_notification_envoyee
    action: input_boolean.turn_off
  mode: single
- id: '1745092585329'
  alias: Simulation PV
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - sensor.simulation_pv
    attribute: derniere_actualisation
  - trigger: state
    entity_id:
    - sensor.solcast_pv_forecast_derniere_interrogation_de_l_api
  conditions: []
  actions:
  - action: shell_command.suivi_pv
    data: {}
  - action: shell_command.comparaison_pv
    data: {}
  mode: single
- id: '1745139428042'
  alias: Mode jour/nuit automatique
  description: 'Bascule automatiquement entre batterie et routeur solaire selon la
    production, avec seuils asymétriques et temporisation pour éviter les bascules
    multiples.

    '
  triggers:
  - id: mode_nuit
    value_template: '{{ states(''sensor.production_solaire'')|float(0) < 0.7 * states(''sensor.consommation_maison'')|float(0)
      }}

      '
    for:
      minutes: 5
    trigger: template
  - id: mode_jour_batterie_negative
    entity_id: sensor.consommation_batterie
    below: -50
    for:
      minutes: 5
    trigger: numeric_state
    enabled: false
  - id: mode_jour_production_forte
    value_template: '{{ states(''sensor.production_solaire'')|float(0) > 1.5 * states(''sensor.consommation_maison'')|float(0)
      and states(''sensor.sonde_temperature_owon_temperature'')|float(0) < 0.8 * states(''input_number.tmax_ecs'')|float(0)}}

      '
    for:
      minutes: 5
    trigger: template
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - mode_nuit
      - condition: state
        entity_id: input_boolean.priorite_batterie
        state: 'off'
      sequence:
      - target:
          entity_id: automation.activer_batterie
        data:
          skip_condition: true
        action: automation.trigger
      - target:
          entity_id: input_boolean.priorite_batterie
        action: input_boolean.turn_on
        data: {}
      - data:
          title: "\U0001F319 Mode nuit activé"
          message: "Production solaire insuffisante ({{ states('sensor.production_solaire')|float(0)|round(0)
            }} W < {{ states('sensor.consommation_maison')|float(0)|round(0) }} W)
            \U0001F50B Batterie réactivée, routeur solaire désactivé.\n"
        action: notify.mobile_app_iphone_de_mat_13
    - conditions:
      - condition: trigger
        id:
        - mode_jour_batterie_negative
        - mode_jour_production_forte
      - condition: state
        entity_id: input_boolean.priorite_batterie
        state: 'on'
      - condition: state
        entity_id: input_boolean.mode_absent
        state: 'off'
      sequence:
      - target:
          entity_id: input_boolean.priorite_batterie
        action: input_boolean.turn_off
        data: {}
      - data:
          title: ☀️ Mode jour activé
          message: "Production solaire suffisante ({{ states('sensor.production_solaire')|float(0)|round(0)
            }} W > {{ states('sensor.consommation_maison')|float(0)|round(0) }} W)
            {% if states('sensor.esphome_web_a92940_marstek_battery_state_of_charge')|float(0)
            <= states('number.esphome_web_a92940_marstek_discharging_cutoff_capacity')|float(0)
            %} ⚠️ Batterie vide : passage immédiat au routeur solaire. {% else %}
            \U0001F50B Batterie mise en pause, routeur solaire priorisé. {% endif
            %}\n"
        action: notify.mobile_app_iphone_de_mat_13
  mode: single
- id: '1746129722706'
  alias: Alerte SOC batterie
  description: Notification si le SOC chute de plus de 10 % entre deux mises à jour
  triggers:
  - entity_id:
    - sensor.esphome_web_a92940_marstek_battery_state_of_charge
    trigger: state
    enabled: false
  - entity_id:
    - sensor.soc_estime_batterie
    trigger: state
  conditions:
  - condition: template
    value_template: '{% set old = trigger.from_state.state | float(0) %} {% set new
      = trigger.to_state.state | float(0) %} {{ old - new > 1 and old <= 100}}

      '
  - condition: numeric_state
    entity_id: sensor.esphome_web_a92940_marstek_battery_state_of_charge
    above: 0
  - condition: numeric_state
    entity_id: sensor.esphome_web_a92940_marstek_battery_state_of_charge
    below: 101
  actions:
  - data:
      title: ⚠️ Chute brutale du SOC
      message: 'Le SOC de la batterie est passé de {{ trigger.from_state.state }} %
        à {{ trigger.to_state.state }} %  (chute de {{ (trigger.from_state.state |
        float - trigger.to_state.state | float) | round(1) }} %) en 5 minutes.

        '
    action: notify.notify
  mode: single
- id: '1746561093976'
  alias: Alerte consommation réseau
  description: ''
  triggers:
  - trigger: numeric_state
    entity_id:
    - sensor.consommation_reseau
    for:
      hours: 0
      minutes: 1
      seconds: 0
    above: 100
  conditions: []
  actions:
  - action: notify.notify
    metadata: {}
    data:
      message: Consommation réseau > 100W depuis 1 min !
  mode: single
- id: '1747392460384'
  alias: Alerte Batterie
  description: ''
  triggers:
  - trigger: numeric_state
    entity_id:
    - number.esphome_web_a92940_marstek_charge_to_soc
    below: 1
    id: charge
  - trigger: state
    entity_id:
    - binary_sensor.communication_batterie
    to: 'on'
  - trigger: state
    entity_id:
    - binary_sensor.capteurs_marstek
    to: 'on'
  conditions: []
  actions:
  - if:
    - condition: trigger
      id:
      - charge
    then:
    - device_id: cad5cf1c1acf9585f1a244da05cf1cac
      domain: number
      entity_id: ef5c510238d1ebfb3e82f0e9403cab08
      type: set_value
      value: 100
    - device_id: cad5cf1c1acf9585f1a244da05cf1cac
      domain: number
      entity_id: ae93c2b49706436fd175cfe883bdea18
      type: set_value
      value: 100
    - device_id: cad5cf1c1acf9585f1a244da05cf1cac
      domain: number
      entity_id: 16bbf2604370b6a7190fc387d13d898b
      type: set_value
      value: 20
  - action: notify.notify
    metadata: {}
    data:
      message: Alerte état de la batterie !
  mode: single
- id: '1747835604993'
  alias: Reset SOC batterie
  description: 'Met à jour input_number.energie_batterie_a_100 depuis le capteur énergie
    estimée : - si SOC = 100% pendant 5 min - ou si bouton appuyé

    '
  triggers:
  - entity_id:
    - sensor.esphome_web_a92940_marstek_battery_state_of_charge
    to: '100.0'
    for:
      minutes: 5
    id: soc_plein
    trigger: state
  - event_type: call_service
    event_data:
      domain: input_button
      service: press
      service_data:
        entity_id: input_button.reset_soc_batterie
    id: bouton
    trigger: event
  - trigger: numeric_state
    entity_id:
    - sensor.esphome_web_a92940_marstek_battery_state_of_charge
    for:
      hours: 0
      minutes: 5
      seconds: 0
    above: 99.9
  conditions: []
  actions:
  - target:
      entity_id: input_number.energie_batterie_a_100
    data:
      value: '{{ states(''sensor.energie_estimee_batterie_dc'') | float(0) }}'
    action: input_number.set_value
  mode: single
- id: '1749591645769'
  alias: MAJ Taux HC
  description: ''
  triggers:
  - at: 00:10:00
    trigger: time
  conditions: []
  actions:
  - action: shell_command.taux_hc
    data: {}
  mode: single
- id: '1750256481184'
  alias: Borne
  description: ''
  triggers:
  - entity_id:
    - sensor.consommation_borne
    above: 5
    trigger: numeric_state
    id: debut
  - entity_id:
    - sensor.consommation_borne
    below: 5
    trigger: numeric_state
    id: fin
  conditions:
  - condition: or
    conditions:
    - condition: and
      conditions:
      - condition: state
        entity_id: input_boolean.borne
        state: 'off'
      - condition: trigger
        id:
        - debut
    - condition: and
      conditions:
      - condition: trigger
        id:
        - fin
      - condition: state
        entity_id: input_boolean.borne
        state: 'on'
  actions:
  - if:
    - condition: trigger
      id:
      - debut
    then:
    - metadata: {}
      data: {}
      target:
        entity_id:
        - input_boolean.borne
      action: input_boolean.turn_on
    - action: input_number.set_value
      metadata: {}
      data:
        value: '{{ states(''sensor.frigo_wh'') | float(0) }}'
      target:
        entity_id: input_number.fin_frigo
      enabled: false
    - action: input_datetime.set_datetime
      target:
        entity_id: input_datetime.dernier_cycle_frigo
      data:
        datetime: '{{state_attr(''automation.debut_frigo'',''last_triggered'')}}'
      enabled: false
    else:
    - data: {}
      target:
        entity_id:
        - input_boolean.borne
      action: input_boolean.turn_off
    - action: input_number.set_value
      metadata: {}
      data:
        value: '{{ states(''sensor.frigo_wh'') | float(0) }}'
      target:
        entity_id: input_number.fin_frigo
      enabled: false
    - action: input_number.set_value
      metadata: {}
      data:
        value: '{{ ((now() - strptime(states(''input_datetime.dernier_cycle_frigo''),
          "%Y-%m-%d %H:%M:%S").astimezone(now().tzinfo)).total_seconds()) | round(0)}}'
      target:
        entity_id: input_number.duree_cycle_frigo
      enabled: false
  mode: single
- id: '1750256687940'
  alias: TV
  description: ''
  triggers:
  - entity_id:
    - sensor.prise_tv_cloud_puissance
    above: 3
    trigger: numeric_state
    id: debut
  - entity_id:
    - sensor.prise_tv_cloud_puissance
    below: 3
    trigger: numeric_state
    id: fin
  conditions:
  - condition: or
    conditions:
    - condition: and
      conditions:
      - condition: state
        entity_id: input_boolean.tv
        state: 'off'
      - condition: trigger
        id:
        - debut
    - condition: and
      conditions:
      - condition: trigger
        id:
        - fin
      - condition: state
        entity_id: input_boolean.tv
        state: 'on'
  actions:
  - if:
    - condition: trigger
      id:
      - debut
    then:
    - metadata: {}
      data: {}
      target:
        entity_id:
        - input_boolean.tv
      action: input_boolean.turn_on
    else:
    - data: {}
      target:
        entity_id:
        - input_boolean.tv
      action: input_boolean.turn_off
  mode: single
- id: '1750256802404'
  alias: Lave Vaisselle
  description: ''
  triggers:
  - entity_id:
    - sensor.prise_lave_vaiselle_local_puissance
    above: 3
    trigger: numeric_state
    id: debut
  - entity_id:
    - sensor.prise_lave_vaiselle_local_puissance
    below: 3
    trigger: numeric_state
    id: fin
  conditions:
  - condition: or
    conditions:
    - condition: and
      conditions:
      - condition: state
        entity_id: input_boolean.lave_vaisselle
        state: 'off'
      - condition: trigger
        id:
        - debut
    - condition: and
      conditions:
      - condition: trigger
        id:
        - fin
      - condition: state
        entity_id: input_boolean.lave_vaisselle
        state: 'on'
  actions:
  - if:
    - condition: trigger
      id:
      - debut
    then:
    - metadata: {}
      data: {}
      target:
        entity_id:
        - input_boolean.lave_vaisselle
      action: input_boolean.turn_on
    else:
    - data: {}
      target:
        entity_id:
        - input_boolean.lave_vaisselle
      action: input_boolean.turn_off
  mode: single
- id: '1750256879660'
  alias: Lave Linge
  description: ''
  triggers:
  - entity_id:
    - sensor.prise_lave_linge_local_puissance
    above: 3
    trigger: numeric_state
    id: debut
  - entity_id:
    - sensor.prise_lave_linge_local_puissance
    below: 3
    trigger: numeric_state
    id: fin
  conditions:
  - condition: or
    conditions:
    - condition: and
      conditions:
      - condition: state
        entity_id: input_boolean.lave_linge
        state: 'off'
      - condition: trigger
        id:
        - debut
    - condition: and
      conditions:
      - condition: trigger
        id:
        - fin
      - condition: state
        entity_id: input_boolean.lave_linge
        state: 'on'
  actions:
  - if:
    - condition: trigger
      id:
      - debut
    then:
    - metadata: {}
      data: {}
      target:
        entity_id:
        - input_boolean.lave_linge
      action: input_boolean.turn_on
    else:
    - data: {}
      target:
        entity_id:
        - input_boolean.lave_linge
      action: input_boolean.turn_off
  mode: single
- id: '1750257739059'
  alias: Clim Salon
  description: ''
  triggers:
  - entity_id:
    - sensor.disjoncteur_4_puissance_2
    above: 20
    trigger: numeric_state
    id: debut
  - entity_id:
    - sensor.disjoncteur_4_puissance_2
    below: 20
    trigger: numeric_state
    id: fin
  conditions:
  - condition: or
    conditions:
    - condition: and
      conditions:
      - condition: state
        entity_id: input_boolean.clim_salon
        state: 'off'
      - condition: trigger
        id:
        - debut
    - condition: and
      conditions:
      - condition: trigger
        id:
        - fin
      - condition: state
        entity_id: input_boolean.clim_salon
        state: 'on'
  actions:
  - if:
    - condition: trigger
      id:
      - debut
    then:
    - metadata: {}
      data: {}
      target:
        entity_id:
        - input_boolean.clim_salon
      action: input_boolean.turn_on
    else:
    - data: {}
      action: input_boolean.turn_off
      target:
        entity_id: input_boolean.clim_salon
  mode: single
- id: '1750257821351'
  alias: Clim Chambres
  description: ''
  triggers:
  - entity_id:
    - sensor.disjoncteur_3_puissance_2
    above: 20
    trigger: numeric_state
    id: debut
  - entity_id:
    - sensor.disjoncteur_3_puissance_2
    below: 20
    trigger: numeric_state
    id: fin
  conditions:
  - condition: or
    conditions:
    - condition: and
      conditions:
      - condition: state
        entity_id: input_boolean.climatisation
        state: 'off'
      - condition: trigger
        id:
        - debut
    - condition: and
      conditions:
      - condition: trigger
        id:
        - fin
      - condition: state
        entity_id: input_boolean.climatisation
        state: 'on'
  actions:
  - if:
    - condition: trigger
      id:
      - debut
    then:
    - metadata: {}
      data: {}
      target:
        entity_id:
        - input_boolean.climatisation
      action: input_boolean.turn_on
    else:
    - data: {}
      action: input_boolean.turn_off
      target:
        entity_id:
        - input_boolean.climatisation
  mode: single
- id: '1750259412433'
  alias: Frigo
  description: ''
  triggers:
  - entity_id:
    - sensor.prise_frigo_local_puissance
    - sensor.prise_frigo_puissance
    above: 3
    trigger: numeric_state
    id: debut
  - entity_id:
    - sensor.prise_frigo_puissance
    - sensor.prise_frigo_local_puissance
    below: 3
    trigger: numeric_state
    id: fin
  conditions:
  - condition: or
    conditions:
    - condition: and
      conditions:
      - condition: state
        entity_id: input_boolean.frigo
        state: 'off'
      - condition: trigger
        id:
        - debut
    - condition: and
      conditions:
      - condition: trigger
        id:
        - fin
      - condition: state
        entity_id: input_boolean.frigo
        state: 'on'
  actions:
  - if:
    - condition: trigger
      id:
      - debut
    then:
    - metadata: {}
      data: {}
      target:
        entity_id: input_boolean.frigo
      action: input_boolean.turn_on
    - action: input_number.set_value
      metadata: {}
      data:
        value: '{{ states(''sensor.frigo_wh'') | float(0) }}'
      target:
        entity_id: input_number.debut_frigo
    - action: input_datetime.set_datetime
      target:
        entity_id: input_datetime.dernier_cycle_frigo
      data:
        datetime: '{{state_attr(''automation.frigo'',''last_triggered'')}}'
    else:
    - data: {}
      target:
        entity_id: input_boolean.frigo
      action: input_boolean.turn_off
    - action: input_number.set_value
      metadata: {}
      data:
        value: '{{ states(''sensor.frigo_wh'') | float(0) }}'
      target:
        entity_id: input_number.fin_frigo
    - action: input_number.increment
      data: {}
      target:
        entity_id:
        - input_number.cycles_frigo
    - action: input_number.set_value
      metadata: {}
      data:
        value: '{{ ((now() - strptime(states(''input_datetime.dernier_cycle_frigo''),
          "%Y-%m-%d %H:%M:%S").astimezone(now().tzinfo)).total_seconds()) | round(0)}}'
      target:
        entity_id: input_number.duree_cycle_frigo
  mode: single
