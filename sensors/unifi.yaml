template:
  - sensor:
      # --- UDR7 ---
      - name: "UDR7 - Clients total (sans fil + filaires)"
        unique_id: udr7_total_clients
        icon: mdi:router-wireless
        state: >
          {% set ap_mac = '1c:0b:8b:4e:50:70' %}
          {% set wireless = (state_attr('sensor.unifi_clients_json','data') or [])
            | selectattr('ap_mac','equalto',ap_mac)
            | list | count %}
          {% set udr7 = (state_attr('sensor.unifi_device_json','data') or []) 
            | selectattr('mac','equalto',ap_mac) | first | default({}) %}
          {% set ports = udr7.get('port_table', []) %}
          {% set wired = ports
                | selectattr('up','equalto',true)
                | selectattr('last_connection','!=',none)
                | list | count %}
          {{ wireless + wired }}

      - name: "UDR7 - Clients 2.4G"
        unique_id: udr7_2_4g_clients
        state: >
          {% set arr = state_attr('sensor.unifi_clients_json','data') or [] %}
          {{ arr | selectattr('ap_mac','equalto','1c:0b:8b:4e:50:70')
            | selectattr('radio','in',['ng','b','g'])
            | list | count }}

      - name: "UDR7 - Clients 5G"
        unique_id: udr7_5g_clients
        state: >
          {% set arr = state_attr('sensor.unifi_clients_json','data') or [] %}
          {{ arr | selectattr('ap_mac','equalto','1c:0b:8b:4e:50:70')
            | selectattr('radio','in',['na','a'])
            | list | count }}

      - name: "UDR7 - Clients 6G"
        unique_id: udr7_6g_clients
        state: >
          {% set arr = state_attr('sensor.unifi_clients_json','data') or [] %}
          {{ arr | selectattr('ap_mac','equalto','1c:0b:8b:4e:50:70')
            | selectattr('radio','in',['6e','6'])
            | list | count }}

      - name: "UDR7 - Clients filaires"
        unique_id: udr7_wired_clients
        state: >
          {% set mac = '1c:0b:8b:4e:50:70' %}
          {% set udr7 = (state_attr('sensor.unifi_device_json','data') or []) 
            | selectattr('mac','equalto',mac) 
            | first | default({}) %}
          {% set ports = udr7.get('port_table', []) %}
          {% set wired = ports | selectattr('up','equalto',true)
            | selectattr('last_connection','!=',none)
            | list | count %}
          {{ wired }}

      - name: "UDR7 - Port 1 - RX (Mbit/s)"
        unique_id: udr7_port_1_rx_mbps
        unit_of_measurement: "Mbit/s"
        state_class: measurement
        device_class: data_rate
        state: >
          {% set mac = '1c:0b:8b:4e:50:70' %}
          {% set devs = state_attr('sensor.unifi_device_json','data') or [] %}
          {% set udr7 = devs | selectattr('mac','equalto',mac) | first | default({}) %}
          {% set ports = udr7.get('port_table', []) %}
          {% set port = (ports | selectattr('port_idx','equalto',1) | first) | default({}) %} 
          {{ (port.get('rx_bytes-r', 0) * 8 / 1000000) | round(1) }}

      - name: "UDR7 - Port 1 - TX (Mbit/s)"
        unique_id: udr7_port_1_tx_mbps
        unit_of_measurement: "Mbit/s"
        state_class: measurement
        device_class: data_rate
        state: >
          {% set mac = '1c:0b:8b:4e:50:70' %}
          {% set devs = state_attr('sensor.unifi_device_json','data') or [] %}
          {% set udr7 = devs | selectattr('mac','equalto',mac) | first | default({}) %}
          {% set ports = udr7.get('port_table', []) %}
          {% set port = (ports | selectattr('port_idx','equalto',1) | first) | default({}) %} 
          {{ (port.get('tx_bytes-r', 0) * 8 / 1000000) | round(1) }}

      - name: "UDR7 - Port 2 - RX (Mbit/s)"
        unique_id: udr7_port_2_rx_mbps
        unit_of_measurement: "Mbit/s"
        state_class: measurement
        device_class: data_rate
        state: >
          {% set mac = '1c:0b:8b:4e:50:70' %}
          {% set devs = state_attr('sensor.unifi_device_json','data') or [] %}
          {% set udr7 = devs | selectattr('mac','equalto',mac) | first | default({}) %}
          {% set ports = udr7.get('port_table', []) %}
          {% set port = (ports | selectattr('port_idx','equalto',2) | first) | default({}) %} 
          {{ (port.get('rx_bytes-r', 0) * 8 / 1000000) | round(1) }}

      - name: "UDR7 - Port 2 - TX (Mbit/s)"
        unique_id: udr7_port_2_tx_mbps
        unit_of_measurement: "Mbit/s"
        state_class: measurement
        device_class: data_rate
        state: >
          {% set mac = '1c:0b:8b:4e:50:70' %}
          {% set devs = state_attr('sensor.unifi_device_json','data') or [] %}
          {% set udr7 = devs | selectattr('mac','equalto',mac) | first | default({}) %}
          {% set ports = udr7.get('port_table', []) %}
          {% set port = (ports | selectattr('port_idx','equalto',2) | first) | default({}) %} 
          {{ (port.get('tx_bytes-r', 0) * 8 / 1000000) | round(1) }}

      - name: "UDR7 - Port 3 - RX (Mbit/s)"
        unique_id: udr7_port_3_rx_mbps
        unit_of_measurement: "Mbit/s"
        state_class: measurement
        device_class: data_rate
        state: >
          {% set mac = '1c:0b:8b:4e:50:70' %}
          {% set devs = state_attr('sensor.unifi_device_json','data') or [] %}
          {% set udr7 = devs | selectattr('mac','equalto',mac) | first | default({}) %}
          {% set ports = udr7.get('port_table', []) %}
          {% set port = (ports | selectattr('port_idx','equalto',3) | first) | default({}) %} 
          {{ (port.get('rx_bytes-r', 0) * 8 / 1000000) | round(1) }}

      - name: "UDR7 - Port 3 - TX (Mbit/s)"
        unique_id: udr7_port_3_tx_mbps
        unit_of_measurement: "Mbit/s"
        state_class: measurement
        device_class: data_rate
        state: >
          {% set mac = '1c:0b:8b:4e:50:70' %}
          {% set devs = state_attr('sensor.unifi_device_json','data') or [] %}
          {% set udr7 = devs | selectattr('mac','equalto',mac) | first | default({}) %}
          {% set ports = udr7.get('port_table', []) %}
          {% set port = (ports | selectattr('port_idx','equalto',3) | first) | default({}) %} 
          {{ (port.get('tx_bytes-r', 0) * 8 / 1000000) | round(1) }}

      - name: "UDR7 - Port 4 - RX (Mbit/s)"
        unique_id: udr7_port_4_rx_mbps
        unit_of_measurement: "Mbit/s"
        state_class: measurement
        device_class: data_rate
        state: >
          {% set mac = '1c:0b:8b:4e:50:70' %}
          {% set devs = state_attr('sensor.unifi_device_json','data') or [] %}
          {% set udr7 = devs | selectattr('mac','equalto',mac) | first | default({}) %}
          {% set ports = udr7.get('port_table', []) %}
          {% set port = (ports | selectattr('port_idx','equalto',4) | first) | default({}) %} 
          {{ (port.get('rx_bytes-r', 0) * 8 / 1000000) | round(1) }}

      - name: "UDR7 - Port 4 - TX (Mbit/s)"
        unique_id: udr7_port_4_tx_mbps
        unit_of_measurement: "Mbit/s"
        state_class: measurement
        device_class: data_rate
        state: >
          {% set mac = '1c:0b:8b:4e:50:70' %}
          {% set devs = state_attr('sensor.unifi_device_json','data') or [] %}
          {% set udr7 = devs | selectattr('mac','equalto',mac) | first | default({}) %}
          {% set ports = udr7.get('port_table', []) %}
          {% set port = (ports | selectattr('port_idx','equalto',4) | first) | default({}) %} 
          {{ (port.get('tx_bytes-r', 0) * 8 / 1000000) | round(1) }}

      # ----------------------------------------------------------------------
      # CAPTEUR UNIQUE ET DÉFINITIF POUR LE DÉBIT RADIO DOWNLINK (6G)
      # ----------------------------------------------------------------------
      - name: "UDR7 - Débit Radio Downlink (Mbps)"
        unique_id: udr7_debit_radio_downlink_mbps
        unit_of_measurement: "Mbit/s"
        state_class: measurement
        device_class: data_rate
        state: >

          {% set wan_rx = float(states('sensor.udr7_port_4_rx_mbps'),0) %}
          {% set total_lan_tx = float(states('sensor.udr7_port_1_tx_mbps'),0) + float(states('sensor.udr7_port_2_tx_mbps'),0) + float(states('sensor.udr7_port_3_tx_mbps'),0)%}


          {# Calcul (WAN RX - LAN TX) et conversion en Mbit/s. Utilise ABS pour assurer la positivité #}
          {% set radio_downlink_bytes_r = wan_rx - total_lan_tx %}

          {{ ((radio_downlink_bytes_r | abs) | round(1)) }}

      # ----------------------------------------------------------------------
      # CAPTEUR POUR LE DÉBIT RADIO UPLINK
      # ----------------------------------------------------------------------
      - name: "UDR7 - Débit Radio Uplink (Mbps)"
        unique_id: udr7_debit_radio_uplink_mbps
        unit_of_measurement: "Mbit/s"
        state_class: measurement
        device_class: data_rate
        state: >

          {% set wan_tx = float(states('sensor.udr7_port_4_tx_mbps'),0) %}
          {% set total_lan_rx = float(states('sensor.udr7_port_1_rx_mbps'),0) + float(states('sensor.udr7_port_2_rx_mbps'),0) + float(states('sensor.udr7_port_3_rx_mbps'),0)%}

          {# Calcul (WAN TX - LAN RX) et conversion en Mbit/s. Utilise ABS pour assurer la positivité #}
          {% set radio_uplink_bytes_r = wan_tx - total_lan_rx %}

          {{ ((radio_uplink_bytes_r | abs) | round(1)) }}

        # --- UDR7 - Signal moyen (dBm) ---
      - name: "UDR7 - Signal 2.4G moyen"
        unique_id: udr7_2_4g_dbm
        state_class: measurement
        device_class: signal_strength
        unit_of_measurement: "dBm"
        state: >
          {% set ap='1c:0b:8b:4e:50:70' %}
          {% set xs = (state_attr('sensor.unifi_clients_json','data') or [])
                | selectattr('ap_mac','equalto',ap)
                | selectattr('radio','in',['ng','g','b'])
                | map(attribute='signal') | select('number') | list %}
          {% set n = xs|length %}
          {{ (xs|sum / n) | round(0) if n>0 else 0 }}

      - name: "UDR7 - Signal 5G moyen"
        unique_id: udr7_5g_dbm
        state_class: measurement
        device_class: signal_strength
        unit_of_measurement: "dBm"
        state: >
          {% set ap='1c:0b:8b:4e:50:70' %}
          {% set xs = (state_attr('sensor.unifi_clients_json','data') or [])
                | selectattr('ap_mac','equalto',ap)
                | selectattr('radio','in',['na','a'])
                | map(attribute='signal') | select('number') | list %}
          {% set n = xs|length %}
          {{ (xs|sum / n) | round(0) if n>0 else 0 }}

      - name: "UDR7 - Signal 6G moyen"
        unique_id: udr7_6g_dbm
        device_class: signal_strength
        state_class: measurement
        unit_of_measurement: "dBm"
        state: >
          {% set ap='1c:0b:8b:4e:50:70' %}
          {% set xs = (state_attr('sensor.unifi_clients_json','data') or [])
                | selectattr('ap_mac','equalto',ap)
                | selectattr('radio','in',['6e','6'])
                | map(attribute='signal') | select('number') | list %}
          {% set n = xs|length %}
          {{ (xs|sum / n) | round(0) if n>0 else 0 }}

      # --- AC Lite ---
      - name: "AC Lite - Clients total"
        unique_id: ac_lite_total_clients
        icon: mdi:access-point
        state: >
          {% set ap_mac = '68:d7:9a:76:53:d6' %}
          {% set arr = state_attr('sensor.unifi_clients_json','data') or [] %}
          {{ arr | selectattr('ap_mac','equalto',ap_mac)
              | list | count }}

      - name: "AC Lite - Clients 2.4G"
        unique_id: ac_lite_2_4g_clients
        state: >
          {% set ap_mac = '68:d7:9a:76:53:d6' %}
          {% set arr = state_attr('sensor.unifi_clients_json','data') or [] %}
          {{ arr | selectattr('ap_mac','equalto',ap_mac)
              | selectattr('radio','in',['ng','b','g'])
              | list | count }}

      - name: "AC Lite - Clients 5G"
        unique_id: ac_lite_5g_clients
        state: >
          {% set ap_mac = '68:d7:9a:76:53:d6' %}
          {% set arr = state_attr('sensor.unifi_clients_json','data') or [] %}
          {{ arr | selectattr('ap_mac','equalto',ap_mac)
              | selectattr('radio','in',['na','a'])
              | list | count }}

        # --- AC Lite - Signal moyen (dBm) ---
      - name: "AC Lite - Signal 2.4G moyen"
        unique_id: ac_lite_2_4g_dbm
        state_class: measurement
        device_class: signal_strength
        unit_of_measurement: "dBm"
        state: >
          {% set ap='68:d7:9a:76:53:d6' %}
          {% set xs = (state_attr('sensor.unifi_clients_json','data') or [])
                | selectattr('ap_mac','equalto',ap)
                | selectattr('radio','in',['ng','g','b'])
                | map(attribute='signal') | select('number') | list %}
          {% set n = xs|length %}
          {{ (xs|sum / n) | round(0) if n>0 else 0 }}

      - name: "AC Lite - Signal 5G moyen"
        unique_id: ac_lite_5g_dbm
        state_class: measurement
        device_class: signal_strength
        unit_of_measurement: "dBm"
        state: >
          {% set ap='68:d7:9a:76:53:d6' %}
          {% set xs = (state_attr('sensor.unifi_clients_json','data') or [])
                | selectattr('ap_mac','equalto',ap)
                | selectattr('radio','in',['na','a'])
                | map(attribute='signal') | select('number') | list %}
          {% set n = xs|length %}
          {{ (xs|sum / n) | round(0) if n>0 else 0 }}
